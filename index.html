<!doctype html>
<html lang="en">
<head>
  <!-- /standard (Kim Sze) | Designed by Lim Kim Sze Â© 2026 -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Addition â€” Money Algorithm (Simple Coins Only)</title>

  <!-- Favicon (Kim Sze standard) -->
  <link rel="icon" href="./kimsze_sharp16.ico?v=20260111a" sizes="any">
  <link rel="shortcut icon" href="./kimsze_sharp16.ico?v=20260111a">

  <!-- Counter.dev (Kim Sze standard) -->
  <script src="https://cdn.counter.dev/script.js" data-id="YOUR_COUNTERDEV_ID" data-utcoffset="8"></script>

  <!-- âœ… Always-Clear on Load (Default Build Contract) -->
  <script>
  (function(){
    const ACTIVITY_ID = (window.ACTIVITY_ID || (location.origin + location.pathname));
    try{
      const del = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(k === ACTIVITY_ID) del.push(k);
        if(k.startsWith(ACTIVITY_ID+"::")) del.push(k);
        if(k.startsWith("sls_scope::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("UFCO-firstSubmit::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("sls_unlike_payload::"+ACTIVITY_ID)) del.push(k);
      }
      del.forEach(k=>localStorage.removeItem(k));
      // common session flags
      sessionStorage.removeItem("unlockedAudio");
    }catch(e){}
    // broadcast clear to sibling tabs (best-effort)
    try{
      const bc = new BroadcastChannel("xapi-state");
      bc.postMessage({type:"clear", activityId:ACTIVITY_ID, ts:Date.now()});
      bc.close();
    }catch(e){}
  })();
  </script>

  <style>
    :root{
      --bg1:#eef2ff;
      --bg2:#e0f2fe;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;

      --good:#16a34a;
      --bad:#dc2626;

      --shadow: 0 18px 50px rgba(2,6,23,.14);
      --r:22px;

      --note100:#60a5fa;
      --note10:#fb7185;
      --note1:#34d399;

      --coin10:#fbbf24;
      --coin5:#f59e0b;

      --carry:#111827;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      background: radial-gradient(1200px 700px at 20% 10%, var(--bg2), transparent 60%),
                  radial-gradient(1200px 700px at 80% 20%, var(--bg1), transparent 60%),
                  linear-gradient(180deg, #f8fafc, #eef2ff);
      min-height:100vh;
      overflow:hidden;
    }

    .app{
      height:100vh;
      display:flex;
      gap:14px;
      padding:14px;
    }

    .left{
      flex: 1 1 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }

    .right{
      width: min(420px, 38vw);
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width: 320px;
    }

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(226,232,240,.9);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      padding:12px 12px 10px;
      overflow:hidden;
    }

    .topbar{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    h1{
      font-size:18px;
      margin:0 0 2px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.25;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
      margin-top:10px;
    }

    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 4px;
    }
    input[type="text"], input[type="number"]{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input:focus{border-color:#94a3b8; box-shadow:0 0 0 3px rgba(99,102,241,.12);}

    .btnRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    button{
      border:none;
      border-radius:16px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      background:#111827;
      color:#fff;
      box-shadow: 0 12px 26px rgba(2,6,23,.18);
    }
    button.secondary{
      background:#f1f5f9;
      color:#111827;
      box-shadow:none;
      border:1px solid #e2e8f0;
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      color:#111827;
      font-weight:800;
      font-size:13px;
    }

    /* === MAT === */
    .matWrap{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    .matTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .grid{
      border:1px solid #dbeafe;
      border-radius:18px;
      overflow:hidden;
      background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(248,250,252,.85));
    }

    .gridHeader{
      display:grid;
      grid-template-columns: 120px repeat(5, 1fr);
      background:linear-gradient(90deg, #e0f2fe, #eef2ff);
      border-bottom:1px solid #dbeafe;
    }
    .hcell{
      padding:10px 8px;
      font-weight:900;
      text-align:center;
      border-right:1px solid rgba(219,234,254,.9);
      font-size:13px;
    }
    .hcell:first-child{
      text-align:left;
      padding-left:12px;
    }
    .hcell:last-child{border-right:none;}

    .row{
      display:grid;
      grid-template-columns: 120px repeat(5, 1fr);
      border-bottom:1px solid rgba(219,234,254,.9);
      min-height:110px;
      background:rgba(255,255,255,.72);
      position:relative;
    }
    .row:last-child{border-bottom:none;}

    .labelCell{
      padding:10px 10px 10px 12px;
      font-weight:900;
      color:#0f172a;
      border-right:1px solid rgba(219,234,254,.9);
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
    }
    .small{
      font-size:12px;
      font-weight:800;
      color:var(--muted);
    }

    .cell{
      position:relative;
      border-right:1px solid rgba(219,234,254,.9);
      padding:8px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      overflow:visible;
      min-height:110px;
    }
    .cell:last-child{border-right:none;}

    /* stacking goes UP like notes */
    .stack{
      display:flex;
      flex-direction:column-reverse; /* newest appears on top visually */
      gap:6px;
      align-items:center;
      justify-content:flex-end;
      width:100%;
      padding-bottom:2px;
    }

    /* tokens */
    .note{
      width:min(92%, 130px);
      height:30px;
      border-radius:10px;
      border:2px solid rgba(15,23,42,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      color:#0b1220;
      text-shadow:0 1px 0 rgba(255,255,255,.55);
      box-shadow: 0 8px 14px rgba(2,6,23,.12);
    }
    .note.n100{ background: linear-gradient(180deg, rgba(96,165,250,.95), rgba(59,130,246,.82));}
    .note.n10 { background: linear-gradient(180deg, rgba(251,113,133,.95), rgba(244,63,94,.82));}
    .note.n1  { background: linear-gradient(180deg, rgba(52,211,153,.95), rgba(16,185,129,.82));}

    .coin{
      width:54px;
      height:54px;
      border-radius:999px;
      border:3px solid rgba(15,23,42,.28);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      color:#0b1220;
      box-shadow: 0 10px 18px rgba(2,6,23,.14);
    }
    .coin.c10{ background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.85), rgba(251,191,36,.95) 42%, rgba(245,158,11,.9) 100%); }
    .coin.c5 { background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.85), rgba(245,158,11,.95) 42%, rgba(217,119,6,.9) 100%); }

    /* carry bubbles (shown above the column) */
    .carry{
      position:absolute;
      top:6px;
      right:8px;
      width:28px;height:28px;
      border-radius:999px;
      background:#111827;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size:14px;
      box-shadow: 0 10px 18px rgba(2,6,23,.18);
      opacity:0;
      transform: translateY(-6px);
      transition: .18s ease;
      pointer-events:none;
      z-index:5;
    }
    .carry.show{
      opacity:1;
      transform: translateY(0);
    }

    /* highlight active column */
    .cell.active{
      outline: 4px solid rgba(99,102,241,.20);
      background: rgba(224,231,255,.45);
    }

    /* === ALGORITHM PANEL: FORCE VISIBLE === */
    #algorithm{
      display:block !important;
      opacity:1 !important;
      visibility:visible !important;
      position:relative;
      z-index:999;
    }
    .algoTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 8px;
    }
    .algoTitle h2{
      font-size:16px;
      margin:0;
    }
    .stepLine{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid #e2e8f0;
      background:#fff;
      margin:8px 0;
      line-height:1.25;
      font-weight:800;
      color:#111827;
    }
    .stepLine small{
      display:block;
      font-weight:900;
      color:#64748b;
      margin-bottom:4px;
      font-size:12px;
    }
    .stepLine.current{
      border-color: rgba(99,102,241,.35);
      box-shadow: 0 0 0 4px rgba(99,102,241,.10);
    }

    .footer{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top:8px;
      color:#64748b;
      font-size:12px;
      font-weight:800;
    }

    /* mobile layout */
    @media (max-width: 980px){
      body{overflow:auto;}
      .app{height:auto; flex-direction:column;}
      .right{width:100%; min-width:0;}
      .gridHeader, .row{grid-template-columns: 110px repeat(5, 1fr);}
      .row{min-height:100px;}
      .cell{min-height:100px;}
      .coin{width:50px;height:50px;}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="left">
      <div class="card">
        <div class="topbar">
          <div>
            <h1>Addition â€” Money Algorithm (Simple Coins)</h1>
            <p class="sub">
              Denominations used: <b>$100, $10, $1, 10Â¢, 5Â¢</b> only.
              Enter two amounts (multiples of 5Â¢), then step through the regrouping algorithm.
            </p>
          </div>
          <div class="pill" id="statusPill">Step: <span id="stepLabel" style="margin-left:6px;">Ready</span></div>
        </div>

        <div class="controls">
          <div class="field">
            <label for="aAmt">Amount A (e.g., 18.35)</label>
            <input id="aAmt" type="text" inputmode="decimal" value="18.35"/>
          </div>
          <div class="field">
            <label for="bAmt">Amount B (e.g., 7.70)</label>
            <input id="bAmt" type="text" inputmode="decimal" value="7.70"/>
          </div>
        </div>

        <div class="btnRow">
          <button id="buildBtn">Build Mat</button>
          <button class="secondary" id="resetBtn">Reset</button>

          <span style="flex:1 1 auto"></span>

          <button class="secondary" id="unlockAudioBtn" title="Tap once before sounds can play on mobile">ðŸ”Š Unlock Sound</button>
          <label class="pill" style="cursor:pointer;">
            <input id="soundOn" type="checkbox" checked style="width:auto; margin:0 6px 0 0;">
            Sound On
          </label>
        </div>
      </div>

      <div class="card matWrap">
        <div class="matTitle">
          <div>
            <div style="font-weight:1000;">Place Value Mat</div>
            <div class="sub" id="hintText">Build the mat first. Then press Next Step.</div>
          </div>
          <div class="btnRow" style="margin:0;">
            <button class="secondary" id="prevBtn" disabled>â—€ Back</button>
            <button id="nextBtn" disabled>Next â–¶</button>
          </div>
        </div>

        <div class="grid" id="grid">
          <div class="gridHeader">
            <div class="hcell">Row</div>
            <div class="hcell">$100</div>
            <div class="hcell">$10</div>
            <div class="hcell">$1</div>
            <div class="hcell">10Â¢</div>
            <div class="hcell">5Â¢</div>
          </div>

          <div class="row" data-row="A">
            <div class="labelCell">
              <div>Amount A</div>
              <div class="small" id="aPretty">â€”</div>
            </div>
            <div class="cell" data-col="100"><div class="carry" id="carry100A"> </div><div class="stack" id="A100"></div></div>
            <div class="cell" data-col="10"><div class="carry" id="carry10A"> </div><div class="stack" id="A10"></div></div>
            <div class="cell" data-col="1"><div class="carry" id="carry1A"> </div><div class="stack" id="A1"></div></div>
            <div class="cell" data-col="10c"><div class="carry" id="carry10cA"> </div><div class="stack" id="A10c"></div></div>
            <div class="cell" data-col="5c"><div class="carry" id="carry5cA"> </div><div class="stack" id="A5c"></div></div>
          </div>

          <div class="row" data-row="B">
            <div class="labelCell">
              <div>Amount B</div>
              <div class="small" id="bPretty">â€”</div>
            </div>
            <div class="cell" data-col="100"><div class="carry" id="carry100B"> </div><div class="stack" id="B100"></div></div>
            <div class="cell" data-col="10"><div class="carry" id="carry10B"> </div><div class="stack" id="B10"></div></div>
            <div class="cell" data-col="1"><div class="carry" id="carry1B"> </div><div class="stack" id="B1"></div></div>
            <div class="cell" data-col="10c"><div class="carry" id="carry10cB"> </div><div class="stack" id="B10c"></div></div>
            <div class="cell" data-col="5c"><div class="carry" id="carry5cB"> </div><div class="stack" id="B5c"></div></div>
          </div>

          <div class="row" data-row="T">
            <div class="labelCell">
              <div>Total</div>
              <div class="small" id="tPretty">â€”</div>
            </div>
            <div class="cell" data-col="100"><div class="carry" id="carry100T"> </div><div class="stack" id="T100"></div></div>
            <div class="cell" data-col="10"><div class="carry" id="carry10T"> </div><div class="stack" id="T10"></div></div>
            <div class="cell" data-col="1"><div class="carry" id="carry1T"> </div><div class="stack" id="T1"></div></div>
            <div class="cell" data-col="10c"><div class="carry" id="carry10cT"> </div><div class="stack" id="T10c"></div></div>
            <div class="cell" data-col="5c"><div class="carry" id="carry5cT"> </div><div class="stack" id="T5c"></div></div>
          </div>
        </div>

        <div class="footer">
          <div>Only these are used: $100, $10, $1, 10Â¢, 5Â¢.</div>
          <div><b>Designed by Lim Kim Sze Â© 2026</b></div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="card" id="algorithm">
        <div class="algoTitle">
          <h2>Algorithm</h2>
          <span class="pill">Carry: <span id="carryText" style="margin-left:6px;">â€”</span></span>
        </div>

        <div id="algoSteps"></div>

        <div class="btnRow" style="margin-top:10px;">
          <button class="secondary" id="showAllBtn">Show All Steps</button>
          <button class="secondary" id="hideAllBtn">Focus Current Step</button>
        </div>

        <p class="sub" style="margin:10px 0 0;">
          Tip: Start from <b>5Â¢</b> â†’ <b>10Â¢</b> â†’ <b>$1</b> â†’ <b>$10</b> â†’ <b>$100</b>.
        </p>
      </div>

      <div class="card">
        <div style="font-weight:1000; margin-bottom:6px;">Sound Kit</div>
        <p class="sub" style="margin-top:0;">
          If audio doesnâ€™t play on mobile, press <b>Unlock Sound</b> once.
        </p>
      </div>
    </div>
  </div>

  <!-- Audio (expects these files in same folder; safe if missing) -->
  <audio id="sndCorrect" src="./correct.mp3" preload="auto"></audio>
  <audio id="sndWrong" src="./wrong.mp3" preload="auto"></audio>
  <audio id="sndClock" src="./clock.mp3" preload="auto"></audio>

  <script>
    // === Denominations (ONLY THESE) ===
    // Values in cents
    const DENOMS = [
      { key:"100",  value:10000, label:"$100", type:"note", cls:"n100" },
      { key:"10",   value:1000,  label:"$10",  type:"note", cls:"n10"  },
      { key:"1",    value:100,   label:"$1",   type:"note", cls:"n1"   },
      { key:"10c",  value:10,    label:"10Â¢",  type:"coin", cls:"c10"  },
      { key:"5c",   value:5,     label:"5Â¢",   type:"coin", cls:"c5"   },
    ];

    const colsOrder = ["5c","10c","1","10","100"]; // algorithm order
    const colIdToStack = (row, col) => document.getElementById(row + col);

    const els = {
      aAmt: document.getElementById("aAmt"),
      bAmt: document.getElementById("bAmt"),
      buildBtn: document.getElementById("buildBtn"),
      resetBtn: document.getElementById("resetBtn"),
      prevBtn: document.getElementById("prevBtn"),
      nextBtn: document.getElementById("nextBtn"),
      stepLabel: document.getElementById("stepLabel"),
      hintText: document.getElementById("hintText"),
      aPretty: document.getElementById("aPretty"),
      bPretty: document.getElementById("bPretty"),
      tPretty: document.getElementById("tPretty"),
      algoSteps: document.getElementById("algoSteps"),
      carryText: document.getElementById("carryText"),
      showAllBtn: document.getElementById("showAllBtn"),
      hideAllBtn: document.getElementById("hideAllBtn"),
      statusPill: document.getElementById("statusPill"),
      unlockAudioBtn: document.getElementById("unlockAudioBtn"),
      soundOn: document.getElementById("soundOn"),
      sndCorrect: document.getElementById("sndCorrect"),
      sndWrong: document.getElementById("sndWrong"),
      sndClock: document.getElementById("sndClock"),
    };

    let state = null;

    function clampTo5c(cents){
      // ensure multiples of 5 cents
      return Math.round(cents/5)*5;
    }

    function parseAmountToCents(s){
      // accepts "18.35", "$18.35", "18", "18.3" -> cents
      s = String(s||"").trim().replace(/\$/g,"");
      if(!s) return NaN;
      if(!/^\d+(\.\d{0,2})?$/.test(s)) return NaN;
      const parts = s.split(".");
      const dollars = parseInt(parts[0]||"0",10);
      const cents = parseInt((parts[1]||"").padEnd(2,"0").slice(0,2)||"0",10);
      return dollars*100 + cents;
    }

    function centsToPretty(c){
      const sign = c<0 ? "-" : "";
      c = Math.abs(c);
      const d = Math.floor(c/100);
      const cc = String(c%100).padStart(2,"0");
      return `${sign}$${d}.${cc}`;
    }

    function decomposeCentsToCounts(cents){
      // greedy using DENOMS (works because 100,10,1,10c,5c is canonical for multiples of 5c)
      const out = { "100":0, "10":0, "1":0, "10c":0, "5c":0 };
      let rem = cents;
      for(const d of DENOMS){
        const n = Math.floor(rem / d.value);
        out[d.key] = n;
        rem -= n*d.value;
      }
      // rem should be 0 if multiple of 5c
      return out;
    }

    function clearAllStacks(){
      ["A","B","T"].forEach(r=>{
        ["100","10","1","10c","5c"].forEach(c=>{
          const el = document.getElementById(r+c);
          if(el) el.innerHTML = "";
        });
      });
    }

    function tokenEl(denomKey){
      const d = DENOMS.find(x=>x.key===denomKey);
      if(!d) return document.createElement("div");
      const div = document.createElement("div");
      if(d.type==="note"){
        div.className = `note ${d.cls}`;
        div.textContent = d.label;
      }else{
        div.className = `coin ${d.cls}`;
        div.textContent = d.label;
      }
      return div;
    }

    function renderRow(rowKey, counts){
      // counts keys: "100","10","1","10c","5c"
      ["100","10","1","10c","5c"].forEach(k=>{
        const stack = document.getElementById(rowKey+k);
        if(!stack) return;
        stack.innerHTML = "";
        const n = counts[k]||0;
        for(let i=0;i<n;i++){
          stack.appendChild(tokenEl(k));
        }
      });
    }

    function setActiveCol(colKey){
      document.querySelectorAll(".cell").forEach(c=>c.classList.remove("active"));
      document.querySelectorAll(`.cell[data-col="${colKey}"]`).forEach(c=>c.classList.add("active"));
    }

    function hideAllCarry(){
      document.querySelectorAll(".carry").forEach(c=>c.classList.remove("show"));
    }

    function showCarryOnTotal(colKey, val){
      // show carry bubble in TOTAL row, on that column (as a reminder)
      const map = { "5c":"carry5cT", "10c":"carry10cT", "1":"carry1T", "10":"carry10T", "100":"carry100T" };
      const id = map[colKey];
      if(!id) return;
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = String(val);
      el.classList.add("show");
    }

    function playSound(which){
      if(!els.soundOn.checked) return;
      try{
        if(which==="correct") els.sndCorrect.currentTime = 0, els.sndCorrect.play();
        if(which==="wrong") els.sndWrong.currentTime = 0, els.sndWrong.play();
        if(which==="clock") els.sndClock.currentTime = 0, els.sndClock.play();
      }catch(e){}
    }

    function unlockAudio(){
      // mobile unlock: play/pause silent-ish quickly
      const a = els.sndCorrect;
      if(!a) return;
      a.volume = 0.001;
      a.play().then(()=>{
        a.pause();
        a.currentTime = 0;
        a.volume = 1;
        sessionStorage.setItem("unlockedAudio","1");
        els.unlockAudioBtn.textContent = "ðŸ”Š Sound Unlocked";
      }).catch(()=>{
        els.unlockAudioBtn.textContent = "ðŸ”Š Tap Again";
      });
    }

    // Build algorithm steps text
    function buildAlgoText(stepIndex, carryObj){
      // stepIndex: -1 = ready; 0..4
      const steps = [
        {
          title: "Step 1 â€” Add 5Â¢",
          body: "Add the 5Â¢ coins. If you get 2Ã—5Â¢, regroup into 1Ã—10Â¢."
        },
        {
          title: "Step 2 â€” Add 10Â¢",
          body: "Add the 10Â¢ coins (including any regrouped 10Â¢). If you get 10Ã—10Â¢ = 100Â¢, regroup into 1Ã—$1."
        },
        {
          title: "Step 3 â€” Add $1",
          body: "Add the $1 notes (including any regrouped $1). If you get 10Ã—$1, regroup into 1Ã—$10."
        },
        {
          title: "Step 4 â€” Add $10",
          body: "Add the $10 notes (including any regrouped $10). If you get 10Ã—$10, regroup into 1Ã—$100."
        },
        {
          title: "Step 5 â€” Add $100",
          body: "Add the $100 notes (including any regrouped $100). Read the final total."
        }
      ];

      const carryStr = (() => {
        if(!carryObj) return "â€”";
        const parts = [];
        if(carryObj["10c"]) parts.push(`to 10Â¢: ${carryObj["10c"]}`);
        if(carryObj["1"]) parts.push(`to $1: ${carryObj["1"]}`);
        if(carryObj["10"]) parts.push(`to $10: ${carryObj["10"]}`);
        if(carryObj["100"]) parts.push(`to $100: ${carryObj["100"]}`);
        return parts.length ? parts.join(" â€¢ ") : "â€”";
      })();
      els.carryText.textContent = carryStr;

      els.algoSteps.innerHTML = steps.map((s,i)=>{
        const isCurrent = (i===stepIndex);
        return `
          <div class="stepLine ${isCurrent ? "current":""}" data-step="${i}">
            <small>${s.title}</small>
            ${s.body}
          </div>
        `;
      }).join("");
    }

    function focusCurrentStep(stepIndex){
      document.querySelectorAll(".stepLine").forEach((el, i)=>{
        el.style.display = (i===stepIndex) ? "block" : "none";
      });
    }

    function showAllSteps(){
      document.querySelectorAll(".stepLine").forEach(el=>el.style.display="block");
    }

    function computeTotalAtStep(step){
      // step: -1 means no totals yet; otherwise totals built progressively
      const A = state.Acounts;
      const B = state.Bcounts;

      const T = { "100":0, "10":0, "1":0, "10c":0, "5c":0 };
      const carry = { "10c":0, "1":0, "10":0, "100":0 };

      // helper to set T columns up to current step
      // order: 5c (0), 10c (1), 1 (2), 10 (3), 100 (4)

      // Step 1: 5c
      if(step >= 0){
        const sum5 = (A["5c"]||0) + (B["5c"]||0);
        carry["10c"] = Math.floor(sum5 / 2); // 2x5c -> 1x10c
        T["5c"] = sum5 % 2;
      }

      // Step 2: 10c
      if(step >= 1){
        const sum10c = (A["10c"]||0) + (B["10c"]||0) + carry["10c"];
        carry["1"] = Math.floor(sum10c / 10); // 10x10c -> 1 dollar
        T["10c"] = sum10c % 10;
      }

      // Step 3: $1
      if(step >= 2){
        const sum1 = (A["1"]||0) + (B["1"]||0) + carry["1"];
        carry["10"] = Math.floor(sum1 / 10);
        T["1"] = sum1 % 10;
      }

      // Step 4: $10
      if(step >= 3){
        const sum10 = (A["10"]||0) + (B["10"]||0) + carry["10"];
        carry["100"] = Math.floor(sum10 / 10);
        T["10"] = sum10 % 10;
      }

      // Step 5: $100
      if(step >= 4){
        const sum100 = (A["100"]||0) + (B["100"]||0) + carry["100"];
        T["100"] = sum100;
      }

      return {T, carry};
    }

    function countsToCents(counts){
      let total = 0;
      for(const d of DENOMS){
        total += (counts[d.key]||0) * d.value;
      }
      return total;
    }

    function updateUIForStep(){
      hideAllCarry();
      const step = state.step;
      const orderCol = colsOrder[Math.max(0, Math.min(step, colsOrder.length-1))] || "5c";
      setActiveCol(orderCol);

      if(step < 0){
        els.stepLabel.textContent = "Ready";
        els.hintText.textContent = "Press Next to begin the algorithm from 5Â¢.";
        renderRow("T", {"100":0,"10":0,"1":0,"10c":0,"5c":0});
        els.tPretty.textContent = "â€”";
        buildAlgoText(-1, null);
        els.prevBtn.disabled = true;
        els.nextBtn.disabled = false;
        return;
      }

      els.stepLabel.textContent = `Step ${step+1} of 5`;
      els.hintText.textContent = "Follow the highlighted column and regroup when needed.";

      const {T, carry} = computeTotalAtStep(step);
      renderRow("T", T);

      // show carry bubble on the *next* column after each step
      if(step === 0 && carry["10c"]) showCarryOnTotal("10c", carry["10c"]);
      if(step === 1 && carry["1"])   showCarryOnTotal("1", carry["1"]);
      if(step === 2 && carry["10"])  showCarryOnTotal("10", carry["10"]);
      if(step === 3 && carry["100"]) showCarryOnTotal("100", carry["100"]);

      // total pretty only at final step
      if(step >= 4){
        const totalCents = countsToCents(T);
        els.tPretty.textContent = centsToPretty(totalCents);
        playSound("correct");
      }else{
        els.tPretty.textContent = "â€¦";
      }

      buildAlgoText(step, carry);

      // button states
      els.prevBtn.disabled = (step <= 0);
      els.nextBtn.disabled = (step >= 4);
    }

    function buildMat(){
      const aC = parseAmountToCents(els.aAmt.value);
      const bC = parseAmountToCents(els.bAmt.value);

      if(!Number.isFinite(aC) || !Number.isFinite(bC)){
        alert("Please enter valid amounts like 18.35 (numbers only, optional decimal).");
        return;
      }

      const aC5 = clampTo5c(aC);
      const bC5 = clampTo5c(bC);

      // must be multiples of 5 cents exactly (after rounding we accept)
      if(aC5 !== aC || bC5 !== bC){
        // accept but also reflect rounded
        els.aAmt.value = (aC5/100).toFixed(2);
        els.bAmt.value = (bC5/100).toFixed(2);
      }

      const Acounts = decomposeCentsToCounts(aC5);
      const Bcounts = decomposeCentsToCounts(bC5);

      state = { A: aC5, B: bC5, Acounts, Bcounts, step: -1 };

      clearAllStacks();
      renderRow("A", Acounts);
      renderRow("B", Bcounts);

      els.aPretty.textContent = centsToPretty(aC5);
      els.bPretty.textContent = centsToPretty(bC5);
      els.tPretty.textContent = "â€”";

      els.nextBtn.disabled = false;
      els.prevBtn.disabled = true;

      showAllSteps();
      buildAlgoText(-1, null);
      focusCurrentStep(0); // will be overridden when stepping
      showAllSteps();      // start with all visible
      els.hintText.textContent = "Mat built. Press Next to begin (start from 5Â¢).";
      els.stepLabel.textContent = "Ready";

      // remove active highlight
      document.querySelectorAll(".cell").forEach(c=>c.classList.remove("active"));
      setActiveCol("5c");
    }

    function resetAll(){
      state = null;
      clearAllStacks();
      els.aPretty.textContent = "â€”";
      els.bPretty.textContent = "â€”";
      els.tPretty.textContent = "â€”";
      els.stepLabel.textContent = "Ready";
      els.hintText.textContent = "Build the mat first. Then press Next Step.";
      els.nextBtn.disabled = true;
      els.prevBtn.disabled = true;
      hideAllCarry();
      document.querySelectorAll(".cell").forEach(c=>c.classList.remove("active"));
      els.algoSteps.innerHTML = "";
      els.carryText.textContent = "â€”";
      els.statusPill.style.background = "#f1f5f9";
    }

    function nextStep(){
      if(!state) return;
      if(state.step < 4) state.step++;
      updateUIForStep();
      // focus current step if user chose focus mode (we use a flag by checking any hidden)
      const anyHidden = Array.from(document.querySelectorAll(".stepLine")).some(el=>el.style.display==="none");
      if(anyHidden) focusCurrentStep(state.step);
    }

    function prevStep(){
      if(!state) return;
      if(state.step > 0) state.step--;
      updateUIForStep();
      const anyHidden = Array.from(document.querySelectorAll(".stepLine")).some(el=>el.style.display==="none");
      if(anyHidden) focusCurrentStep(state.step);
    }

    // Wire up
    els.buildBtn.addEventListener("click", buildMat);
    els.resetBtn.addEventListener("click", resetAll);
    els.nextBtn.addEventListener("click", nextStep);
    els.prevBtn.addEventListener("click", prevStep);

    els.showAllBtn.addEventListener("click", ()=>{
      showAllSteps();
    });
    els.hideAllBtn.addEventListener("click", ()=>{
      if(!state) return;
      focusCurrentStep(Math.max(0, state.step));
    });

    els.unlockAudioBtn.addEventListener("click", unlockAudio);

    // Enter key builds mat
    [els.aAmt, els.bAmt].forEach(inp=>{
      inp.addEventListener("keydown", (e)=>{
        if(e.key==="Enter") buildMat();
      });
    });

    // Start clean
    resetAll();
  </script>
</body>
</html>         5Â¢ / 10Â¢ / $1 now align with $10/$50/$100 notes */
      --tokenH: 44px;
      --coinS: 44px;     /* coin width/height */
      --noteW: 78px;     /* note width */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      -webkit-text-size-adjust: 100%;
    }

    .topbar{
      height:auto;
      min-height: var(--topbarH);
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 10px 14px;
      position: sticky;
      top:0;
      z-index: 20;
    }
    .title{
      display:flex;
      align-items:baseline;
      gap:10px;
      font-weight:1000;
      letter-spacing:.2px;
      min-width: 140px;
    }
    .title .big{ font-size: 18px; }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:1000;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill strong{ color: var(--ink); }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:1000;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      transition: transform .08s ease;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background:#0f172a;
      border-color:#0f172a;
      color:#fff;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .wrap{
      height: auto;
      min-height: calc(100vh - var(--topbarH));
      max-width: var(--maxW);
      margin: 0 auto;
      padding: 12px 14px 14px;
      display:grid;
      grid-template-columns: 1.55fr .85fr;
      gap: var(--gap);
      overflow: visible;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    .leftCard{
      display:grid;
      grid-template-rows: auto 1fr auto;
      min-height:0;
    }
    .cardHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead .h{
      font-weight:1000;
      letter-spacing:.2px;
    }
    .cardHead .sub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      line-height:1.25;
    }

    .matWrap{
      padding: 12px 14px 12px;
      min-height:0;
    }
    .mat{
      position: relative;
      height: 100%;
      min-height: 520px;
      border-radius: 22px;
      border: 2px solid rgba(15,23,42,.16);
      overflow:hidden;
      background:#fff;
    }

    /* two regions: dollars / cents */
    .matGrid{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-rows: auto 1fr;
    }
    .matHeader{
      display:grid;
      grid-template-columns: 1fr 1fr;
      border-bottom: 1px solid rgba(15,23,42,.12);
      background: linear-gradient(180deg, rgba(241,245,249,.85), rgba(241,245,249,.25));
    }
    .matHeader .sec{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:1000;
    }
    .matHeader .sec .tag{
      font-size:12px;
      font-weight:1000;
      color: var(--muted);
      border:1px solid var(--line);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .matBody{
      display:grid;
      grid-template-columns: 1fr 1fr;
      min-height:0;
    }
    .secBody{
      position:relative;
      min-height:0;
      padding: 10px 10px 10px;
      overflow:hidden;
    }
    .secBody.dollars{
      background: linear-gradient(180deg, rgba(223,247,255,.95), rgba(223,247,255,.35));
      border-right: 1px solid rgba(15,23,42,.10);
    }
    .secBody.cents{
      background: linear-gradient(180deg, rgba(255,241,219,.92), rgba(255,241,219,.32));
    }
    body.animating .secBody{ background:#fff !important; }

    /* columns per section */
    .denomCols{
      position:absolute;
      inset:0;
      display:grid;
      gap: 10px;
      padding: 10px;
      align-content: stretch;
      justify-content: stretch;
    }
    .denomCol{
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.82);
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      overflow:hidden;
      display:grid;
      grid-template-rows: auto 1fr;
      min-height:0;
    }
    .denomHead{
      padding: 8px 10px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      font-weight:1000;
    }
    .denomHead .label{
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .denomHead .mini{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }
    .pileWrap{
      padding: 10px;
      min-height:0;
      display:grid;
      place-items:center;
    }
    .fitBox{
      transform-origin:center;
      will-change: transform;
    }
    .pile{
      display:grid;
      grid-template-columns: repeat(5, max-content);
      grid-auto-rows: max-content;
      justify-content:center;
      align-content:center;
      gap: 10px;
      transform-origin:center;
      will-change: transform;
    }

    /* tokens */
    .token{
      user-select:none;
      pointer-events:none;
      position:relative;
      display:grid;
      place-items:center;
      transition: transform var(--moveDur) var(--ease), opacity var(--moveDur) var(--ease);
      height: var(--tokenH);            /* âœ… unify height */
    }
    .token.coin{
      width: var(--coinS);
      height: var(--coinS);
      border-radius: 999px;
      border: 3px solid rgba(15,23,42,.16);
      box-shadow: 0 12px 18px rgba(0,0,0,.16), inset 0 -8px 14px rgba(0,0,0,.10);
    }
    .token.note{
      width: var(--noteW);
      height: var(--tokenH);           /* âœ… same as coins */
      border-radius: 12px;
      border: 3px solid rgba(15,23,42,.18);
      box-shadow: 0 12px 18px rgba(0,0,0,.16), inset 0 -8px 14px rgba(0,0,0,.10);
    }
    .token .txt{
      font-weight: 1000;
      color: rgba(0,0,0,.85);
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
      font-size: 14px;
      white-space:nowrap;
      padding: 0 6px;
      text-align:center;
      line-height: 1.05;
    }

    .movingHidden{ opacity:0 !important; transform: scale(.85) !important; }

    .eqBar{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(233,243,242,.65), rgba(233,243,242,.18));
      display:flex;
      flex-direction: column;
      align-items:flex-start;
      justify-content:flex-start;
      gap: 8px;
    }
    .eq{
      font-weight: 1000;
      letter-spacing:.2px;
      font-size: clamp(26px, 3.6vw, 48px);
      display:flex;
      align-items:center;
      gap: 12px;
      white-space:nowrap;
      flex-wrap:wrap;
    }
    .ansPill{
      min-width: 130px;
      height: 54px;
      border-radius: 16px;
      border: 3px solid rgba(44,93,0,.35);
      background: rgba(214,255,180,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: 30px;
      color:#000;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      padding: 0 12px;
    }
    .eqHint{
      font-size:12px;
      color: var(--muted);
      font-weight: 900;
      line-height:1.25;
    }

    .rightCol{
      display:grid;
      grid-template-rows: auto 1fr;
      gap: var(--gap);
      min-height:0;
    }
    .panelHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelHead .h{
      font-weight:1000;
      letter-spacing:.2px;
    }
    .panelHead .small{
      font-size:12px;
      color: var(--muted);
      font-weight: 900;
      white-space:nowrap;
    }

    .panelBody{
      padding: 12px 14px 14px;
      display:grid;
      gap: 12px;
      min-height:0;
    }

    .stepCard{
      border: 2px solid rgba(245,158,11,.75);
      border-radius: 18px;
      padding: 12px 12px;
      display:grid;
      gap: 6px;
      background:#fff;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }
    .stepTitle{
      font-weight:1000;
      font-size: 30px;
      letter-spacing:.2px;
      color: #f59e0b;
      text-decoration: underline;
      text-underline-offset: 6px;
    }
    .stepText{
      font-weight:1000;
      font-size: 18px;
      color:#000;
      line-height:1.25;
    }
    .stepEq{
      font-weight:1000;
      font-size: 18px;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      color:#000;
    }
    .miniBox{
      min-width: 92px;
      height: 44px;
      border-radius: 14px;
      border: 3px solid rgba(44,93,0,.35);
      background: rgba(214,255,180,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: 22px;
      color:#000;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      padding: 0 10px;
    }
    .miniBox.mystery{ color: rgba(0,0,0,.35); }

    .teacherWrap{
      border-radius: 18px;
      background:#fff;
      border: 1px solid var(--line);
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .teacherWrap .inner{
      padding: 10px 12px 12px;
      display:grid;
      gap: 10px;
    }
    .fields{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    label{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      display:block;
      margin-bottom: 6px;
    }
    input[type="number"], select{
      width:100%;
      padding: 10px 10px;
      border: 1px solid var(--line);
      border-radius: 14px;
      font-size: 14px;
      font-weight: 900;
      outline:none;
      background:#fff;
    }
    .rowBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 2px;
    }
    .seg{
      display:flex;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .seg button{
      border:0;
      background:transparent;
      padding: 10px 12px;
      font-weight:1000;
      font-size:13px;
      color: var(--muted);
      cursor:pointer;
      white-space:nowrap;
    }
    .seg button.active{
      background:#0f172a;
      color:#fff;
    }

    .noteErr{
      font-size:12px;
      font-weight: 900;
      color:#b91c1c;
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.25);
      padding: 10px 12px;
      border-radius: 14px;
      display:none;
      line-height:1.25;
    }

    .credit{
      position: fixed;
      right: 14px;
      bottom: 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      z-index: 5;
      pointer-events:none;
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; padding: 10px 10px 14px; }
      .mat{ min-height: 520px; }
      .cardHead, .panelHead, .panelBody, .matWrap, .eqBar{ padding-left: 12px; padding-right: 12px; }
    }
    @media (max-width: 640px){
      :root{ --gap: 10px; --tokenH: 44px; --coinS: 44px; --noteW: 74px; }
      .title .big{ font-size: 16px; }
      .actions{ gap:8px; justify-content:flex-start; }
      .pill{ font-size: 11px; padding: 6px 8px; }
      .btn{ padding: 10px 10px; font-size: 13px; border-radius: 14px; }
      .fields{ grid-template-columns: 1fr; }
      .token .txt{ font-size: 13px; }
      .credit{
        position: static;
        padding: 10px 12px 14px;
        text-align: right;
      }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="title">
      <span class="big">Money Subtraction</span>
    </div>

    <div class="actions">
      <div class="pill"><span>A:</span><strong id="pillA">$12.35</strong></div>
      <div class="pill"><span>B:</span><strong id="pillB">$7.80</strong></div>
      <div class="pill"><span>Order:</span><strong id="pillOrder">Cents â†’ Dollars</strong></div>
      <button class="btn" id="btnReset">â†º Reset</button>
      <button class="btn primary" id="btnNext">Next Step â–¶</button>
      <button class="btn" id="btnDone" disabled>Done âœ“</button>
    </div>
  </div>

  <div class="wrap">
    <section class="card leftCard">
      <div class="cardHead">
        <div>
          <div class="h" id="prompt">(a) Subtract $7.80 from $12.35.</div>
          <div class="sub" id="subNote">
            Click <b>Next Step</b> to make change (rename) when needed, then subtract in the chosen order.
            <br><b>SGD cents are in multiples of 5Â¢</b> (no 1Â¢ coins).
          </div>
        </div>
      </div>

      <div class="matWrap">
        <div class="mat" id="mat">
          <div class="matGrid">
            <div class="matHeader">
              <div class="sec">
                <div>ðŸ’µ Dollars</div>
                <div class="tag">Denoms: $100, $50, $10, $5, $2, $1</div>
              </div>
              <div class="sec">
                <div>ðŸª™ Cents</div>
                <div class="tag">Denoms: 50Â¢, 20Â¢, 10Â¢, 5Â¢</div>
              </div>
            </div>

            <div class="matBody">
              <div class="secBody dollars">
                <div class="denomCols" id="dollarCols"></div>
              </div>
              <div class="secBody cents">
                <div class="denomCols" id="centCols"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="eqBar">
        <div class="eq">
          <span id="eqA">$12.35</span>
          <span>âˆ’</span>
          <span id="eqB">$7.80</span>
          <span>=</span>
          <span class="ansPill" id="eqAns">?</span>
        </div>
        <div class="eqHint" id="eqHint">Click Next Step</div>
      </div>
    </section>

    <aside class="card">
      <div class="panelHead">
        <div class="h">Teaching Panel</div>
        <div class="small">Make change â†’ Subtract</div>
      </div>

      <div class="panelBody">
        <div class="stepCard" id="stepCard">
          <div class="stepTitle" id="stepTitle">STEP 1</div>
          <div class="stepText" id="stepText">Make change if needed.</div>
          <div class="stepEq">
            <span id="stepL">?</span>
            <span>=</span>
            <span class="miniBox mystery" id="stepAns">?</span>
          </div>
        </div>

        <div class="teacherWrap">
          <div class="inner">
            <div class="fields">
              <div>
                <label>Amount A â€” dollars</label>
                <input id="inAd" type="number" min="0" max="9999" step="1" value="12"/>
              </div>
              <div>
                <label>Amount A â€” cents (0â€“95, multiple of 5)</label>
                <input id="inAc" type="number" min="0" max="95" step="5" value="35"/>
              </div>
            </div>

            <div class="fields">
              <div>
                <label>Amount B â€” dollars</label>
                <input id="inBd" type="number" min="0" max="9999" step="1" value="7"/>
              </div>
              <div>
                <label>Amount B â€” cents (0â€“95, multiple of 5)</label>
                <input id="inBc" type="number" min="0" max="95" step="5" value="80"/>
              </div>
            </div>

            <div class="rowBtns">
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn primary" id="btnApply">Apply</button>
                <button class="btn" id="btnSwap">Swap A/B</button>
              </div>

              <div class="seg" aria-label="Order">
                <button type="button" id="btnCentsFirst" class="active">Cents â†’ Dollars</button>
                <button type="button" id="btnDollarsFirst">Dollars â†’ Cents</button>
              </div>
            </div>

            <div class="noteErr" id="errBox"></div>
            <div style="font-size:12px; color:var(--muted); font-weight:900; line-height:1.25;">
              Notes:
              <ul style="margin:8px 0 0 18px; padding:0;">
                <li>SGD: no 1Â¢ denomination, so cents must be multiples of 5Â¢.</li>
                <li>When borrowing 1 dollar to cents, the app changes <b>$1 â†’ 10Ã—10Â¢</b> (clean, standard teaching regroup).</li>
                <li>Within cents, it changes <b>50Â¢ â†’ 5Ã—10Â¢</b> and <b>20Â¢ â†’ 2Ã—10Â¢</b> when needed.</li>
                <li>Within dollars, it changes <b>$10 â†’ 10Ã—$1</b>, <b>$5 â†’ 5Ã—$1</b>, <b>$2 â†’ 2Ã—$1</b> (and $50/$100 into $10s if needed).</li>
              </ul>
            </div>
          </div>
        </div>

      </div>
    </aside>
  </div>

  <div class="credit">Designed by Lim Kim Sze Â© 2026</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ======= Denominations (SGD strict; NO 1Â¢) =======
  const DOLLAR_DENOMS = [100, 50, 10, 5, 2, 1];        // dollars
  const CENT_DENOMS   = [50, 20, 10, 5];               // cents (no 1)

  const CHANGE = {
    "$100": [{k:"$", v:10, n:10}],
    "$50" : [{k:"$", v:10, n:5}],
    "$10" : [{k:"$", v:1,  n:10}],
    "$5"  : [{k:"$", v:1,  n:5}],
    "$2"  : [{k:"$", v:1,  n:2}],
    "$1"  : [{k:"c", v:10, n:10}],   // $1 -> 10Ã—10Â¢
    "c50" : [{k:"c", v:10, n:5}],
    "c20" : [{k:"c", v:10, n:2}],
    "c10" : [{k:"c", v:5,  n:2}],
  };

  const ui = {
    pillA: $("pillA"), pillB: $("pillB"), pillOrder: $("pillOrder"),
    eqA: $("eqA"), eqB: $("eqB"), eqAns: $("eqAns"), eqHint: $("eqHint"),
    prompt: $("prompt"),
    inAd: $("inAd"), inAc: $("inAc"), inBd: $("inBd"), inBc: $("inBc"),
    btnApply: $("btnApply"), btnSwap: $("btnSwap"),
    btnCentsFirst: $("btnCentsFirst"), btnDollarsFirst: $("btnDollarsFirst"),
    btnReset: $("btnReset"), btnNext: $("btnNext"), btnDone: $("btnDone"),
    stepTitle: $("stepTitle"), stepText: $("stepText"), stepL: $("stepL"), stepAns: $("stepAns"),
    errBox: $("errBox"),
    dollarCols: $("dollarCols"),
    centCols: $("centCols"),
  };

  // ======= Tiny audio =======
  let audioCtx = null;
  function ensureAudio(){
    if (audioCtx) return audioCtx;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return null;
    audioCtx = new Ctx();
    return audioCtx;
  }
  function resumeAudioIfNeeded(){
    const ctx = ensureAudio();
    if (!ctx) return;
    if (ctx.state === "suspended") ctx.resume().catch(()=>{});
  }
  window.addEventListener("pointerdown", resumeAudioIfNeeded, { passive:true });

  function playClick(){
    const ctx = ensureAudio(); if (!ctx) return;
    const t0 = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(760, t0);
    o.frequency.exponentialRampToValueAtTime(260, t0 + 0.03);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.20, t0 + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.07);
    o.connect(g).connect(ctx.destination);
    o.start(t0);
    o.stop(t0 + 0.08);
  }
  function playSwoosh(){
    const ctx = ensureAudio(); if (!ctx) return;
    const t0 = ctx.currentTime;
    const dur = 0.26;
    const bufferSize = Math.floor(ctx.sampleRate * dur);
    const buf = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<bufferSize;i++){
      const x = i / bufferSize;
      const env = Math.sin(Math.PI * x);
      data[i] = (Math.random()*2-1) * env * 0.9;
    }
    const src = ctx.createBufferSource(); src.buffer = buf;
    const filter = ctx.createBiquadFilter();
    filter.type = "bandpass";
    filter.frequency.setValueAtTime(900, t0);
    filter.frequency.exponentialRampToValueAtTime(220, t0 + dur);
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.18, t0 + 0.05);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    src.connect(filter).connect(g).connect(ctx.destination);
    src.start(t0);
    src.stop(t0 + dur + 0.02);
  }

  // ======= Helpers =======
  const clampInt = (x, min, max) => {
    let n = parseInt(String(x ?? "").trim(), 10);
    if (!Number.isFinite(n)) n = 0;
    n = Math.floor(n);
    return Math.max(min, Math.min(max, n));
  };

  function showErr(msg){
    ui.errBox.style.display = msg ? "block" : "none";
    ui.errBox.textContent = msg || "";
  }

  function moneyToCents(d, c){ return clampInt(d, 0, 9999)*100 + clampInt(c, 0, 95); }
  function centsToMoney(totalCents){
    totalCents = Math.max(0, Math.floor(totalCents));
    return { d: Math.floor(totalCents/100), c: totalCents%100 };
  }
  function fmtMoney(d, c){
    d = Math.max(0, Math.floor(d));
    c = Math.max(0, Math.floor(c));
    return `$${d}.${String(c).padStart(2,"0")}`;
  }
  function isValidCentAmount(c){
    c = clampInt(c, 0, 95);
    return (c % 5 === 0);
  }

  // ======= Visual token styles =======
  function tokenStyle(kind, v){
    const key = `${kind}${v}`;
    const palette = {
      "$100": ["#c7f9cc","#57cc99"],
      "$50" : ["#dbeafe","#60a5fa"],
      "$10" : ["#fde68a","#f59e0b"],
      "$5"  : ["#fecaca","#ef4444"],
      "$2"  : ["#e9d5ff","#a78bfa"],
      "$1"  : ["#cffafe","#22d3ee"],
      "c50" : ["#dcfce7","#22c55e"],
      "c20" : ["#ffedd5","#fb923c"],
      "c10" : ["#e0f2fe","#38bdf8"],
      "c5"  : ["#fae8ff","#d946ef"],
    };
    const [a,b] = palette[key] || ["#f1f5f9","#cbd5e1"];
    return `linear-gradient(180deg, ${a} 0%, ${b} 100%)`;
  }

  function makeTokenEl(kind, v){
    const el = document.createElement("div");
    const isNote = (kind==="$" && v>=5);
    el.className = "token " + (isNote ? "note" : "coin");
    el.style.background = tokenStyle(kind, v);

    const t = document.createElement("div");
    t.className = "txt";
    t.textContent = (kind==="$") ? `$${v}` : `${v}Â¢`;
    el.appendChild(t);
    return el;
  }

  // ======= Build mat columns =======
  const zone = { dollars:{}, cents:{} };

  function makeDenomCol(kind, v){
    const col = document.createElement("div");
    col.className = "denomCol";
    col.dataset.kind = kind;
    col.dataset.v = String(v);

    const head = document.createElement("div");
    head.className = "denomHead";

    const lab = document.createElement("div");
    lab.className = "label";
    const chip = document.createElement("span");
    chip.className = "mini";
    chip.textContent = (kind==="$") ? `$${v}` : `${v}Â¢`;
    lab.appendChild(chip);

    const cnt = document.createElement("div");
    cnt.className = "mini";
    cnt.innerHTML = `count: <b id="cnt_${kind}${v}">0</b>`;

    head.appendChild(lab);
    head.appendChild(cnt);

    const pw = document.createElement("div");
    pw.className = "pileWrap";
    const fit = document.createElement("div");
    fit.className = "fitBox";
    const pile = document.createElement("div");
    pile.className = "pile";
    pile.dataset.kind = kind;
    pile.dataset.v = String(v);
    fit.appendChild(pile);
    pw.appendChild(fit);

    col.appendChild(head);
    col.appendChild(pw);

    return { col, pile, fit };
  }

  function fitAll(){
    const fits = document.querySelectorAll(".fitBox");
    fits.forEach(f => {
      f.style.transform = "scale(1)";
      const p = f.parentElement;
      if (!p) return;
      const availW = p.clientWidth - 10;
      const availH = p.clientHeight - 10;
      const w = f.scrollWidth;
      const h = f.scrollHeight;
      if (w < 1 || h < 1) return;
      const s = Math.min(1, availW / w, availH / h);
      f.style.transform = `scale(${s})`;
    });
  }

  // ======= Greedy decomposition =======
  function decompose(totalCents){
    totalCents = Math.max(0, Math.floor(totalCents));
    const d = Math.floor(totalCents/100);
    const c = totalCents%100;

    let dollars = d;
    let cents = c;

    const out = { "$": {}, c: {} };
    DOLLAR_DENOMS.forEach(v => out["$"][v] = 0);
    CENT_DENOMS.forEach(v => out.c[v] = 0);

    for (const v of DOLLAR_DENOMS){
      const n = Math.floor(dollars / v);
      out["$"][v] = n;
      dollars -= n*v;
    }
    for (const v of CENT_DENOMS){
      const n = Math.floor(cents / v);
      out.c[v] = n;
      cents -= n*v;
    }
    return out;
  }

  // ======= State =======
  let order = "centsFirst";
  let A = {d:12, c:35};
  let B = {d:7,  c:80};

  let pileCounts = { "$": {}, c:{} };
  let actions = [];
  let actionIndex = 0;
  let busy = false;

  // ======= Rendering =======
  function setCount(kind, v, n){
    pileCounts[kind][v] = n;
    const el = document.getElementById(`cnt_${kind}${v}`);
    if (el) el.textContent = String(n);
  }

  function renderPile(kind, v){
    const z = (kind==="$") ? zone.dollars[v] : zone.cents[v];
    if (!z) return;
    const pile = z.pile;
    pile.innerHTML = "";
    const n = pileCounts[kind][v] || 0;
    for (let i=0;i<n;i++) pile.appendChild(makeTokenEl(kind, v));
  }

  function renderAllPiles(){
    for (const v of DOLLAR_DENOMS) renderPile("$", v);
    for (const v of CENT_DENOMS) renderPile("c", v);
    requestAnimationFrame(fitAll);
  }

  function setPillTexts(){
    const aStr = fmtMoney(A.d, A.c);
    const bStr = fmtMoney(B.d, B.c);
    ui.pillA.textContent = aStr;
    ui.pillB.textContent = bStr;
    ui.eqA.textContent = aStr;
    ui.eqB.textContent = bStr;
    ui.prompt.textContent = `(a) Subtract ${bStr} from ${aStr}.`;
    ui.pillOrder.textContent = (order==="centsFirst") ? "Cents â†’ Dollars" : "Dollars â†’ Cents";
  }

  // ======= Action builder =======
  function key(kind, v){ return (kind==="$") ? `$${v}` : `c${v}`; }
  function addChangeAction(fromKind, fromV){
    const rule = CHANGE[key(fromKind, fromV)];
    if (!rule) return null;
    return { type:"change", fromKind, fromV, to: rule.map(x => ({kind:x.k, v:x.v, n:x.n})) };
  }
  function addSubtractAction(kind, v, n){ return { type:"subtract", kind, v, n }; }

  function buildMoneyActions(){
    const At = moneyToCents(A.d, A.c);
    const Bt = moneyToCents(B.d, B.c);
    const want = decompose(Bt);
    const work = JSON.parse(JSON.stringify(pileCounts));
    const out = [];

    const doCents = () => {
      const den = [5,10,20,50];
      const get = (v)=> work.c[v]||0;

      for (const v of den){
        const need = want.c[v]||0;

        while (get(v) < need){
          let donor = null;
          if (v===5){
            if (get(10)>0) donor=10;
            else if (get(20)>0) donor=20;
            else if (get(50)>0) donor=50;
          } else if (v===10){
            if (get(20)>0) donor=20;
            else if (get(50)>0) donor=50;
          } else if (v===20){
            if (get(50)>0) donor=50;
          }

          if (donor === null){
            if ((work["$"][1]||0) > 0){
              out.push(addChangeAction("$",1));
              work["$"][1] -= 1;
              work.c[10] = (work.c[10]||0) + 10;
              continue;
            }
            const dollarDonor = [2,5,10,50,100].find(dv => (work["$"][dv]||0) > 0);
            if (dollarDonor){
              out.push(addChangeAction("$", dollarDonor));
              work["$"][dollarDonor] -= 1;
              for (const r of CHANGE[`$${dollarDonor}`]){
                work[r.k][r.v] = (work[r.k][r.v]||0) + r.n;
              }
              continue;
            }
            break;
          } else {
            out.push(addChangeAction("c", donor));
            work.c[donor] -= 1;
            for (const r of CHANGE[`c${donor}`]){
              work[r.k][r.v] = (work[r.k][r.v]||0) + r.n;
            }
          }
        }

        const needNow = want.c[v]||0;
        if (needNow > 0){
          out.push(addSubtractAction("c", v, needNow));
          work.c[v] -= needNow;
        }
      }
    };

    const doDollars = () => {
      const get = (v)=> work["$"][v]||0;

      // ensure $1 if needed
      const need1 = want["$"][1]||0;
      while (get(1) < need1){
        const donor = [2,5,10,50,100].find(dv => get(dv) > 0);
        if (!donor) break;
        out.push(addChangeAction("$", donor));
        work["$"][donor] -= 1;
        for (const r of CHANGE[`$${donor}`]){
          work[r.k][r.v] = (work[r.k][r.v]||0) + r.n;
        }
      }

      const orderSub = [100,50,10,5,2,1];
      for (const v of orderSub){
        const n = want["$"][v]||0;
        if (n>0){
          out.push(addSubtractAction("$", v, n));
          work["$"][v] -= n;
        }
      }
    };

    if (order === "centsFirst"){ doCents(); doDollars(); }
    else { doDollars(); doCents(); }

    out.push({ type:"finish" });
    return out;
  }

  // ======= Apply actions =======
  function setStepCard(text, eqL, ansText, mystery){
    ui.stepText.textContent = text;
    ui.stepL.textContent = eqL || "";
    ui.stepAns.textContent = ansText || "?";
    ui.stepAns.classList.toggle("mystery", !!mystery);
  }

  function countTotalCentsFromPiles(){
    let total = 0;
    for (const v of DOLLAR_DENOMS) total += (pileCounts["$"][v]||0) * v * 100;
    for (const v of CENT_DENOMS) total += (pileCounts.c[v]||0) * v;
    return total;
  }

  async function animateRemove(kind, v, n){
    n = Math.max(0, Math.floor(n));
    if (n<=0) return;

    const z = (kind==="$") ? zone.dollars[v] : zone.cents[v];
    if (!z) return;

    const pile = z.pile;
    const tokens = Array.from(pile.children).slice(-n);
    tokens.forEach(t => t.classList.add("movingHidden"));
    playSwoosh();

    await new Promise(r => setTimeout(r, 420));

    tokens.forEach(t => t.remove());
    setCount(kind, v, (pileCounts[kind][v]||0) - n);
    renderPile(kind, v);
  }

  async function animateChange(fromKind, fromV, toList){
    const fromZ = (fromKind==="$") ? zone.dollars[fromV] : zone.cents[fromV];
    if (!fromZ) return;

    const pile = fromZ.pile;
    const donor = Array.from(pile.children).slice(-1)[0];
    if (!donor) return;

    donor.classList.add("movingHidden");
    playSwoosh();
    await new Promise(r => setTimeout(r, 320));
    donor.remove();

    setCount(fromKind, fromV, (pileCounts[fromKind][fromV]||0) - 1);
    renderPile(fromKind, fromV);

    for (const t of toList){
      setCount(t.kind, t.v, (pileCounts[t.kind][t.v]||0) + t.n);
      renderPile(t.kind, t.v);
    }

    playClick();
    requestAnimationFrame(fitAll);
  }

  async function doNext(){
    if (busy) return;
    const a = actions[actionIndex];
    if (!a) return;
    busy = true;

    ui.btnNext.disabled = true;
    ui.stepTitle.textContent = `STEP ${actionIndex + 1}`;

    if (a.type === "change"){
      const fromLabel = (a.fromKind==="$") ? `$${a.fromV}` : `${a.fromV}Â¢`;
      const toLabel = a.to.map(x => `${x.n}Ã—${x.kind==="$" ? "$"+x.v : x.v+"Â¢"}`).join(" + ");
      setStepCard(`Make change: change 1Ã—${fromLabel} into ${toLabel}.`, `1Ã—${fromLabel} = ${toLabel}`, "âœ“", false);
      document.body.classList.add("animating");
      await animateChange(a.fromKind, a.fromV, a.to);
      document.body.classList.remove("animating");
      actionIndex++;
      ui.btnNext.disabled = false;
      busy = false;
      updateEq();
      return;
    }

    if (a.type === "subtract"){
      const lab = (a.kind==="$") ? `$${a.v}` : `${a.v}Â¢`;
      setStepCard(`Subtract: remove ${a.n} of ${lab}.`, `${a.n}Ã—${lab}`, "?", true);
      document.body.classList.add("animating");
      await animateRemove(a.kind, a.v, a.n);
      document.body.classList.remove("animating");

      const remaining = pileCounts[a.kind][a.v] || 0;
      ui.stepAns.textContent = `left: ${remaining}`;
      ui.stepAns.classList.remove("mystery");

      actionIndex++;
      ui.btnNext.disabled = false;
      busy = false;
      updateEq();
      return;
    }

    if (a.type === "finish"){
      const diff = moneyToCents(A.d, A.c) - moneyToCents(B.d, B.c);
      const m = centsToMoney(diff);
      setStepCard("All steps completed.", "Done", "âœ“", false);
      ui.eqAns.textContent = fmtMoney(m.d, m.c);
      ui.eqHint.textContent = "Done!";
      ui.btnDone.disabled = false;
      ui.btnNext.disabled = true;
      playClick();
      actionIndex++;
      busy = false;
      return;
    }

    actionIndex++;
    ui.btnNext.disabled = false;
    busy = false;
  }

  function updateEq(){
    const At = moneyToCents(A.d, A.c);
    const Bt = moneyToCents(B.d, B.c);
    const correct = At - Bt;
    const remain = countTotalCentsFromPiles();
    const m = centsToMoney(remain);

    ui.eqAns.textContent = (actionIndex >= actions.length-1) ? fmtMoney(centsToMoney(correct).d, centsToMoney(correct).c) : "?";
    ui.eqHint.textContent = `Working value: ${fmtMoney(m.d, m.c)}. Click Next Step.`;
  }

  // ======= Init / rebuild =======
  function rebuildZones(){
    ui.dollarCols.innerHTML = "";
    ui.centCols.innerHTML = "";

    ui.dollarCols.style.gridTemplateColumns = "repeat(3, minmax(0, 1fr))";
    ui.centCols.style.gridTemplateColumns = "repeat(2, minmax(0, 1fr))";

    zone.dollars = {};
    for (const v of DOLLAR_DENOMS){
      const obj = makeDenomCol("$", v);
      ui.dollarCols.appendChild(obj.col);
      zone.dollars[v] = obj;
    }
    zone.cents = {};
    for (const v of CENT_DENOMS){
      const obj = makeDenomCol("c", v);
      ui.centCols.appendChild(obj.col);
      zone.cents[v] = obj;
    }
  }

  function resetProcess(){
    actionIndex = 0;
    actions = buildMoneyActions();
    ui.eqAns.textContent = "?";
    ui.eqHint.textContent = "Click Next Step";
    ui.btnDone.disabled = true;
    ui.btnNext.disabled = false;
    ui.stepTitle.textContent = "STEP 1";
    setStepCard("Make change if needed.", "Start", "?", true);
    updateEq();
  }

  function loadFromInputs(){
    const Ad = clampInt(ui.inAd.value, 0, 9999);
    const Ac = clampInt(ui.inAc.value, 0, 95);
    const Bd = clampInt(ui.inBd.value, 0, 9999);
    const Bc = clampInt(ui.inBc.value, 0, 95);

    if (!isValidCentAmount(Ac) || !isValidCentAmount(Bc)){
      showErr("SGD cents must be multiples of 5Â¢ (0, 5, 10, â€¦, 95). There is no 1Â¢ coin.");
      return null;
    }
    const At = moneyToCents(Ad, Ac);
    const Bt = moneyToCents(Bd, Bc);
    if (Bt > At){
      showErr("For subtraction, Amount A must be â‰¥ Amount B. (Tip: use Swap A/B).");
      return null;
    }
    showErr("");
    A = { d: Ad, c: Ac };
    B = { d: Bd, c: Bc };
    return {At, Bt};
  }

  function applyAll(){
    const ok = loadFromInputs();
    if (!ok) return;

    setPillTexts();

    const decA = decompose(moneyToCents(A.d, A.c));
    pileCounts = { "$": {}, c:{} };
    for (const v of DOLLAR_DENOMS) pileCounts["$"][v] = decA["$"][v] || 0;
    for (const v of CENT_DENOMS) pileCounts.c[v] = decA.c[v] || 0;

    for (const v of DOLLAR_DENOMS) setCount("$", v, pileCounts["$"][v]);
    for (const v of CENT_DENOMS) setCount("c", v, pileCounts.c[v]);

    renderAllPiles();
    resetProcess();
  }

  function applyOrderUI(){
    ui.btnCentsFirst.classList.toggle("active", order==="centsFirst");
    ui.btnDollarsFirst.classList.toggle("active", order==="dollarsFirst");
    ui.pillOrder.textContent = (order==="centsFirst") ? "Cents â†’ Dollars" : "Dollars â†’ Cents";
  }

  // ======= Events =======
  ui.btnApply.addEventListener("click", () => applyAll());
  ui.btnSwap.addEventListener("click", () => {
    const Ad = ui.inAd.value, Ac = ui.inAc.value;
    ui.inAd.value = ui.inBd.value; ui.inAc.value = ui.inBc.value;
    ui.inBd.value = Ad;           ui.inBc.value = Ac;
    applyAll();
  });

  ui.btnCentsFirst.addEventListener("click", () => { order = "centsFirst"; applyOrderUI(); applyAll(); });
  ui.btnDollarsFirst.addEventListener("click", () => { order = "dollarsFirst"; applyOrderUI(); applyAll(); });

  ui.btnReset.addEventListener("click", () => applyAll());
  ui.btnNext.addEventListener("click", () => doNext());
  window.addEventListener("resize", () => requestAnimationFrame(fitAll));

  // ======= Init =======
  rebuildZones();
  applyOrderUI();
  setPillTexts();
  applyAll();
})();
</script>

</body>
</html>
