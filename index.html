<!doctype html>
<html lang="en">
<head>
  <!-- Money Subtraction (Step-by-step) | Designed by Lim Kim Sze Â© 2026 -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Subtraction â€” Money Algorithm (Step-by-step)</title>

  <!-- Favicon (Kim Sze standard) -->
  <link rel="icon" href="./kimsze_sharp16.ico?v=20260111a" sizes="any">
  <link rel="shortcut icon" href="./kimsze_sharp16.ico?v=20260111a">

  <!-- âœ… Always-Clear on Load (Default Build Contract) -->
  <script>
  (function(){
    const ACTIVITY_ID = (window.ACTIVITY_ID || (location.origin + location.pathname));
    try{
      const del = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(k === ACTIVITY_ID) del.push(k);
        if(k.startsWith(ACTIVITY_ID+"::")) del.push(k);
        if(k.startsWith("sls_scope::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("UFCO-firstSubmit::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("sls_unlike_payload::"+ACTIVITY_ID)) del.push(k);
      }
      del.forEach(k=>localStorage.removeItem(k));
      sessionStorage.removeItem("UFCO:firstSubmit");
      sessionStorage.removeItem("UFCO:lastState");
      try{
        const ch = new BroadcastChannel("xapi-state");
        ch.postMessage({type:"clear", activityId: ACTIVITY_ID, ts: Date.now()});
        ch.close();
      }catch(e){}
    }catch(e){}
  })();
  </script>

  <style>
    :root{
      --bg:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;

      --card:#ffffff;
      --shadow:0 14px 30px rgba(2,6,23,.10);
      --radius:22px;

      /* Animation */
      --moveDur: 1200ms;
      --regroupDur: 1000ms;
      --ease: cubic-bezier(.2,.85,.2,1);

      /* Layout */
      --topbarH: 62px;
      --gap: 14px;
      --maxW: 1500px; /* âœ… bigger overall so Teaching Panel can fit */

      /* Algorithm grid */
      --algoGap: 14px;
      --algoColW: 62px; /* âœ… bigger digits */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      -webkit-text-size-adjust: 100%;
    }

    .topbar{
      height:auto;
      min-height: var(--topbarH);
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 10px 14px;
      position: sticky;
      top:0;
      z-index: 20;
    }
    .title{
      display:flex;
      align-items:baseline;
      gap:10px;
      font-weight:1000;
      letter-spacing:.2px;
      min-width: 160px;
    }
    .title .big{ font-size: 18px; }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:1000;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill strong{ color: var(--ink); }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:1000;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      transition: transform .08s ease;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background:#0f172a;
      border-color:#0f172a;
      color:#fff;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .wrap{
      height: auto;
      min-height: calc(100vh - var(--topbarH));
      max-width: var(--maxW);
      margin: 0 auto;
      padding: 12px 14px 14px;
      display:grid;
      grid-template-columns: 1.35fr 1fr; /* âœ… give Teaching Panel more space */
      gap: var(--gap);
      overflow: visible;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    .leftCard{
      display:grid;
      grid-template-rows: auto 1fr auto;
      min-height:0;
    }
    .cardHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .cardHead .h{
      font-weight:1000;
      letter-spacing:.2px;
    }
    .cardHead .sub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }

    /* âœ… bigger question */
    #prompt{
      font-size: 26px;
      line-height: 1.15;
    }

    .matWrap{
      padding: 12px 14px 12px;
      min-height:0;
    }
    .mat{
      position: relative;
      height: 100%;
      min-height: 460px;
      border-radius: 22px;
      border: 2px solid rgba(15,23,42,.16);
      overflow:hidden;
      background:#fff;
    }

    .cols{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns: repeat(var(--cols, 6), 1fr);
    }
    .col{
      background: linear-gradient(180deg, rgba(241,245,249,.95), rgba(241,245,249,.45));
    }
    .col.tint0{ background: linear-gradient(180deg, rgba(255,246,217,.95), rgba(255,246,217,.42)); } /* $100 */
    .col.tint1{ background: linear-gradient(180deg, rgba(255,241,219,.92), rgba(255,241,219,.42)); } /* $10 */
    .col.tint2{ background: linear-gradient(180deg, rgba(255,228,241,.88), rgba(255,228,241,.38)); } /* $1 */
    .col.tint3{ background: linear-gradient(180deg, rgba(223,247,255,.95), rgba(223,247,255,.42)); } /* 10c */
    .col.tint4{ background: linear-gradient(180deg, rgba(230,240,255,.92), rgba(230,240,255,.42)); } /* 5c */

    body.animating .col{ background: #fff !important; }

    .vSep{
      position:absolute;
      top:0; bottom:0;
      width:2px;
      background: rgba(15,23,42,.10);
      pointer-events:none;
    }

    /* Dot separator between dollars & cents on mat */
    .dotSep{
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #000;
      box-shadow: 0 2px 0 rgba(255,255,255,.7), inset 0 0 0 3px rgba(255,255,255,.65);
      pointer-events:none;
      z-index: 3;
    }

    .zones{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns: repeat(var(--cols, 6), 1fr);
      grid-template-rows: 1fr;
      pointer-events:none;
      z-index: 2;
    }
    .zone{
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .zoneInner{
      width:100%;
      height:100%;
      display:grid;
      place-items:center;
      min-height:0;
    }

    .fitBox{
      transform-origin:center;
      will-change: transform;
    }
    .digitsCol .blank{ opacity:0; border:0; background:transparent; }

    .pile{ width:100%; height:100%; transform-origin:center; will-change: transform; }

    /* âœ… CHANGE: vertical stack (single column) for notes/coins in each mat column */
    .pileTwoCol{
      --rowGap: 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      gap: var(--rowGap);
      height: 100%;
    }
    /* keep these for JS compatibility, but we only use colL now */
    .pileTwoCol .colL,
    .pileTwoCol .colR{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      gap: var(--rowGap);
    }
    .pileTwoCol .colR{ display:none; } /* âœ… ensure true single vertical stack */

    /* ======= YOUR NOTE/COIN DESIGN ======= */

    .wallet{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .noteMock{
      width:108px; height:58px;
      border-radius:14px;
      border:2px solid rgba(15,23,42,.16);
      background:
        radial-gradient(circle at 18% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
        linear-gradient(135deg, rgba(14,165,233,.25), rgba(139,92,246,.18));
      box-shadow:0 10px 18px rgba(2,6,23,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      letter-spacing:.3px;
      position:relative;
      user-select:none;
      overflow:hidden;
    }
    .noteMock:before{
      content:"";
      position:absolute;
      inset:8px;
      border-radius:10px;
      border:2px dashed rgba(15,23,42,.16);
      pointer-events:none;
      opacity:.95;
      z-index:1;
    }
    .noteMock small{
      display:block;
      font-size:10px;
      font-weight:1000;
      opacity:.8;
      letter-spacing:1px;
      text-transform:uppercase;
      text-align:center;
      margin-top:2px;
    }

    .coinMini{
      width:52px;height:52px;border-radius:50%;
      display:grid; place-items:center;
      border:2px solid rgba(15,23,42,.14);
      font-weight:1000;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
        radial-gradient(circle at 70% 75%, rgba(0,0,0,.12), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.25));
      box-shadow:0 10px 18px rgba(2,6,23,.10);
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .coinMini:after{
      content:"";
      position:absolute;
      inset:6px;
      border-radius:50%;
      border:2px dotted rgba(15,23,42,.16);
      pointer-events:none;
    }

    .bankRow{display:flex; gap:10px; flex-wrap:wrap;}
    .coinBtn,.noteBtn{border:none; background:transparent; padding:0; cursor:pointer; user-select:none;}

    .coin{
      width:68px;height:68px;border-radius:50%;
      display:grid; place-items:center;
      position:relative;
      filter: drop-shadow(0 8px 14px rgba(2,6,23,.14));
    }
    .coin:before{
      content:"";
      position:absolute; inset:0;
      border-radius:50%;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.85), rgba(255,255,255,0) 40%),
        radial-gradient(circle at 70% 75%, rgba(0,0,0,.14), rgba(0,0,0,0) 50%);
      mix-blend-mode:overlay;
      pointer-events:none;
    }
    .coin .ring{
      position:absolute; inset:6px;
      border-radius:50%;
      border:2px dashed rgba(15,23,42,.18);
      pointer-events:none;
    }
    .coin .inner{
      width:52px;height:52px;border-radius:50%;
      display:grid; place-items:center;
      border:2px solid rgba(15,23,42,.16);
      background:rgba(255,255,255,.35);
      backdrop-filter: blur(3px);
      font-weight:1000;
      letter-spacing:.2px;
    }
    .coin .inner span{font-size:16px}
    .coin .inner small{
      display:block;
      font-size:10px;
      font-weight:1000;
      letter-spacing:.7px;
      opacity:.85;
      margin-top:1px;
      text-transform:uppercase;
    }
    .c5{  background: radial-gradient(circle at 30% 25%, #fff, #c7f9cc 40%, #4ade80 100%); }
    .c10{ background: radial-gradient(circle at 30% 25%, #fff, #bae6fd 40%, #38bdf8 100%); }
    .c20{ background: radial-gradient(circle at 30% 25%, #fff, #fecaca 40%, #fb7185 100%); }
    .c50{ background: radial-gradient(circle at 30% 25%, #fff, #fde68a 40%, #f59e0b 100%); }

    .noteCard{
      width:140px; height:74px;
      border-radius:18px;
      border:2px solid rgba(15,23,42,.16);
      background:
        radial-gradient(circle at 18% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
        linear-gradient(135deg, rgba(34,197,94,.18), rgba(14,165,233,.14));
      box-shadow:0 10px 18px rgba(2,6,23,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      position:relative;
      overflow:hidden;
      user-select:none;
    }
    .noteCard:before{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:14px;
      border:2px dotted rgba(15,23,42,.16);
      pointer-events:none;
      z-index:1;
    }
    .noteCard small{
      display:block;
      font-size:10px;
      opacity:.78;
      letter-spacing:1px;
      text-transform:uppercase;
      text-align:center;
      margin-top:2px;
    }
    .noteCard.ten{
      background:
        radial-gradient(circle at 18% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
        linear-gradient(135deg, rgba(251,191,36,.18), rgba(139,92,246,.12));
    }
    .noteCard.fifty{
      background:
        radial-gradient(circle at 18% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
        linear-gradient(135deg, rgba(239,68,68,.16), rgba(14,165,233,.12));
    }

    .token{
      position:relative;
      display:inline-block;
      user-select:none;
      transition:transform .08s ease;
    }
    .token .coin{ width:68px; height:68px; }
    .token .x{
      position:absolute;
      right:-6px; top:-6px;
      width:20px;height:20px;border-radius:50%;
      background:#e11d48;
      color:#fff;
      font-size:12px;
      display:grid; place-items:center;
      border:2px solid #fff;
      box-shadow:0 8px 14px rgba(2,6,23,.16);
      z-index:3;
    }

    .tokenNote{
      width:118px;height:64px;border-radius:16px;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      border:2px solid rgba(15,23,42,.14);
      background:#ffffffcc;
      font-weight:1000;
      position:relative;
      box-shadow:0 10px 18px rgba(2,6,23,.10);
      user-select:none;
      overflow:hidden;
    }
    .tokenNote small{font-size:10px; opacity:.75; letter-spacing:1px; text-transform:uppercase}
    .tokenNote .x{
      position:absolute;
      right:-6px; top:-6px;
      width:20px;height:20px;border-radius:50%;
      background:#e11d48;
      color:#fff;
      font-size:12px;
      display:grid; place-items:center;
      border:2px solid #fff;
      box-shadow:0 8px 14px rgba(2,6,23,.16);
      z-index:3;
    }

    .coinOct{
      width:74px; height:74px;
      display:grid; place-items:center;
      font-weight:1000;
      border:2px solid rgba(15,23,42,.16);
      filter: drop-shadow(0 10px 16px rgba(2,6,23,.14));
      clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.95), rgba(255,255,255,0) 42%),
        radial-gradient(circle at 70% 75%, rgba(0,0,0,.18), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, #fff7c2 0%, #fbbf24 55%, #b45309 100%);
      position:relative;
      user-select:none;
      overflow:hidden;
    }
    .coinOct:before{
      content:"";
      position:absolute;
      inset:8px;
      clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
      border:2px dashed rgba(15,23,42,.16);
      opacity:.9;
      pointer-events:none;
    }
    .coinOct small{
      display:block;
      font-size:10px;
      font-weight:1000;
      letter-spacing:.7px;
      opacity:.8;
      margin-top:2px;
      text-transform:uppercase;
    }

    .tokenNote.tokenCoin1{
      width:74px; height:74px;
      border-radius:0;
      clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.95), rgba(255,255,255,0) 42%),
        radial-gradient(circle at 70% 75%, rgba(0,0,0,.18), rgba(0,0,0,0) 55%),
        linear-gradient(180deg, #fff7c2 0%, #fbbf24 55%, #b45309 100%);
      display:grid;
      place-items:center;
      padding:0;
    }
    .tokenNote.tokenCoin1 small{display:none;}

    .lionStamp{
      position:absolute;
      left:10px;
      top:50%;
      transform: translateY(-50%);
      width:44px;
      height:44px;
      opacity:.85;
      z-index: 1;
      pointer-events:none;
      filter: drop-shadow(0 2px 0 rgba(255,255,255,.55));
    }
    .noteFace{
      position:relative;
      z-index: 2;
      text-align:center;
      padding: 0 12px 0 54px;
      line-height: 1.05;
    }

    .animLayer{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 80;
    }
    .confettiLayer{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 95;
      overflow: hidden;
    }
    .ghost{
      position: fixed;
      left:0; top:0;
      will-change: transform, opacity, filter;
      pointer-events:none;
      z-index: 90;
    }
    .ghost.xout:after{
      content:"âœ•";
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-size: 34px;
      font-weight: 1000;
      color: rgba(225,29,72,.95);
      text-shadow: 0 2px 0 rgba(255,255,255,.55);
      pointer-events:none;
    }
    .movingHidden{ opacity: 0 !important; }

    .eqBar{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(233,243,242,.65), rgba(233,243,242,.18));
      display:flex;
      flex-direction: column;
      align-items:flex-start;
      justify-content:flex-start;
      gap: 8px;
    }
    .eq{
      font-weight: 1000;
      letter-spacing:.2px;
      font-size: clamp(26px, 3.2vw, 46px);
      display:flex;
      align-items:center;
      gap: 12px;
      white-space:nowrap;
      flex-wrap: wrap;
    }
    .ansPill{
      min-width: 110px;
      height: 54px;
      border-radius: 16px;
      border: 3px solid rgba(44,93,0,.35);
      background: rgba(214,255,180,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: 32px;
      color:#000;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
    }
    .eqHint{
      font-size:12px;
      color: var(--muted);
      font-weight: 900;
    }

    .rightCol{
      display:grid;
      grid-template-rows: auto 1fr;
      gap: var(--gap);
      min-height:0;
    }

    .panelHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelHead .h{
      font-weight:1000;
      letter-spacing:.2px;
    }
    .panelHead .small{
      font-size:12px;
      color: var(--muted);
      font-weight: 900;
      white-space:nowrap;
    }

    .panelBody{
      display:grid;
      grid-template-rows: 360px auto; /* âœ… bigger algorithm area */
      gap: 18px;
      padding: 12px 14px 14px;
      min-height:0;
    }

    /* âœ… FIX 1: stop clipping when scaled (green boxes/digits disappearing) */
    .algoBox{
      border-radius: 18px;
      background:#fff;
      border: 1px solid var(--line);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      overflow: visible;        /* âœ… was hidden */
      display:grid;
      align-items:start;
      justify-items:start;
      padding: 14px 14px 12px;  /* âœ… more breathing room */
      height: 360px;            /* âœ… enforce */
    }

    /* âœ… FIX 2: prevent algo content collapsing to 0 width/height */
    .algoFit{
      transform-origin: top left;
      will-change: transform;
      display: inline-block;    /* âœ… critical */
      width: max-content;       /* âœ… keep full width for measuring */
      max-width: 100%;
    }

    /* === Algorithm layout: $ [dollars] . [coins] === */
    .pvLabels{
      display:grid;
      grid-template-columns: 44px var(--algoColW) var(--algoColW) var(--algoColW) 24px var(--algoColW) var(--algoColW);
      column-gap: var(--algoGap);
      align-items:end;
      justify-content:start;
      font-weight:1000;
      letter-spacing:.2px;
      font-size: 16px;
      margin-bottom: 6px;
      padding-left: 2px;
      white-space:nowrap;
      width: max-content;       /* âœ… keep from shrinking */
    }
    .pvLabels .lab{
      height: 22px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      color: var(--muted);
      font-weight:1000;
    }
    .pvLabels .dollars{ grid-column: 2 / span 3; color:#f97316; }
    .pvLabels .coins{ grid-column: 6 / span 2; color:#0ea5e9; }
    .pvLabels .blank{ opacity:0; }

    .stack{
      display:grid;
      grid-template-columns: 44px auto;
      gap: 12px;
      align-items:center;
      justify-items:start;
      width: max-content;       /* âœ… keep from shrinking */
    }

    .renameRow{
      display:grid;
      grid-template-columns: 44px var(--algoColW) var(--algoColW) var(--algoColW) 24px var(--algoColW) var(--algoColW);
      column-gap: var(--algoGap);
      align-items:end;
      justify-content:start;
      font-weight:1000;
      white-space:nowrap;
      font-size: 18px;
      line-height: .95;
      margin-bottom: 6px;
      width: max-content;       /* âœ… keep from shrinking */
    }
    .renameRow span{
      height: 28px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 12px;
    }
    .renameRow .blank{ opacity:0; border:0; background:transparent; }
    .renameRow .dotCell{ font-size: 24px; opacity:.75; }
    .renameRow .moneyCell{ opacity:0; }
    .renameRow .renamed{
      background: rgba(250,204,21,.28);
      border: 2px solid rgba(245,158,11,.65);
    }

    .minus{
      font-weight:1000;
      font-size: 30px;
      justify-self:start;
      padding-left: 2px;
    }

    .digitsCol{
      display:grid;
      grid-template-columns: 44px var(--algoColW) var(--algoColW) var(--algoColW) 24px var(--algoColW) var(--algoColW);
      column-gap: var(--algoGap);
      align-items:end;
      justify-content:start;
      font-weight:1000;
      color:#000;
      white-space:nowrap;
      font-size: 40px;
      line-height: .92;
      position: relative;
      width: max-content;       /* âœ… keep from shrinking */
    }
    .digitsCol span{
      height: 46px;
      text-align:center;
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
      border-radius: 14px;
      background: rgba(15,23,42,.03);
      border: 1px solid rgba(15,23,42,.08);
    }
    .digitsCol .moneySym{
      font-size: 40px;
      background: transparent;
      border: none;
      justify-content:flex-start;
      padding-left: 6px;
    }
    .digitsCol .dotCell{
      font-size: 40px;
      background: transparent;
      border: none;
      opacity:.9;
    }
    .digitsCol span.strike:after{
      content:"";
      position:absolute;
      left:8px;
      right:8px;
      top:52%;
      height:4px;
      background: rgba(225,29,72,.75);
      border-radius: 999px;
      transform: rotate(-10deg);
      box-shadow: 0 2px 0 rgba(255,255,255,.55);
      pointer-events:none;
    }

    .barLine{
      height: 6px;
      width: 100%;
      background: #0f172a;
      border-radius: 999px;
      margin-top: 4px;
    }

    .resultRow{
      display:grid;
      grid-template-columns: 44px var(--algoColW) var(--algoColW) var(--algoColW) 24px var(--algoColW) var(--algoColW);
      column-gap: var(--algoGap);
      align-items:center;
      justify-content:start;
      margin-top: 10px;
      width: max-content;       /* âœ… keep from shrinking */
    }
    .resBox{
      height: 56px;
      border-radius: 16px;
      border: 3px solid rgba(44,93,0,.35);
      background: rgba(214,255,180,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: 32px;
      color:#000;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      min-width: 0;
      flex: 0 0 auto;           /* âœ… never shrink away (extra safety) */
    }
    .resBox.mystery{ color: rgba(0,0,0,.35); }
    .resBox.blankCell{
      background: transparent;
      border: none;
      box-shadow:none;
      font-size: 40px;
      justify-content:flex-start;
      padding-left: 6px;
    }
    .resBox.dotCell{
      background: transparent;
      border: none;
      box-shadow:none;
      font-size: 40px;
      opacity:.9;
    }
    .ghost0{ opacity:.35; }

    .lowerPanel{
      border-radius: 18px;
      background:#fff;
      border: 1px solid var(--line);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      overflow:hidden;
    }

    .stepCard{
      border: 2px solid rgba(245,158,11,.75);
      border-radius: 18px;
      margin: 12px 12px 10px;
      padding: 12px 12px;
      display:grid;
      gap: 6px;
      background:#fff;
    }
    .stepTitle{
      font-weight:1000;
      font-size: 34px;
      letter-spacing:.2px;
      color: #f59e0b;
      text-decoration: underline;
      text-underline-offset: 6px;
    }
    .stepText{
      font-weight:1000;
      font-size: 20px;
      color:#000;
    }
    .stepEq{
      font-weight:1000;
      font-size: 20px;
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .miniBox{
      min-width: 64px;
      height: 44px;
      border-radius: 14px;
      border: 3px solid rgba(44,93,0,.35);
      background: rgba(214,255,180,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      font-size: 26px;
      color:#000;
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      padding: 0 10px;
    }
    .miniBox.mystery{ color: rgba(0,0,0,.35); }

    .teacherWrap{
      padding: 10px 12px 12px;
      display:grid;
      gap: 10px;
    }
    .fields{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    label{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      display:block;
      margin-bottom: 6px;
    }
    input[type="text"], select{
      width:100%;
      padding: 10px 10px;
      border: 1px solid var(--line);
      border-radius: 14px;
      font-size: 14px;
      font-weight: 900;
      outline:none;
      background:#fff;
    }
    .rowBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 2px;
    }
    .noteErr{
      font-size:12px;
      font-weight: 900;
      color:#b91c1c;
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.25);
      padding: 10px 12px;
      border-radius: 14px;
      display:none;
      line-height: 1.25;
    }
    .randRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:end;
    }
    .randRow .btn{ width:100%; }

    .childPanel{
      margin: 0 12px 12px;
      border-radius: 18px;
      border: 2px dashed rgba(14,165,233,.55);
      background: linear-gradient(180deg, rgba(224,242,254,.65), rgba(255,255,255,.9));
      padding: 12px 12px;
      display:grid;
      gap: 10px;
    }
    .childTitleRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .childTitle{
      font-weight:1000;
      letter-spacing:.2px;
      color:#0369a1;
      font-size: 16px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .childBadge{
      font-size:12px;
      font-weight:1000;
      color: var(--muted);
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      white-space:nowrap;
    }
    .childGrid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:end;
    }
    .childMsg{
      font-size:12px;
      font-weight: 900;
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid transparent;
      display:none;
      line-height:1.25;
    }
    .childMsg.ok{
      display:block;
      color:#14532d;
      background: rgba(34,197,94,.10);
      border-color: rgba(34,197,94,.25);
    }
    .childMsg.bad{
      display:block;
      color:#7f1d1d;
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.25);
    }

    @keyframes panelPulse{
      0%{ box-shadow: 0 0 0 rgba(14,165,233,0); }
      35%{ box-shadow: 0 0 0 6px rgba(14,165,233,.18); }
      70%{ box-shadow: 0 0 0 0 rgba(14,165,233,0); }
      100%{ box-shadow: 0 0 0 rgba(14,165,233,0); }
    }
    .pulseTeacher{
      animation: panelPulse 900ms ease-in-out 0s 2;
      border-color: rgba(14,165,233,.55) !important;
    }

    .credit{
      position: fixed;
      right: 14px;
      bottom: 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      z-index: 5;
      pointer-events:none;
    }

    @media (max-width: 1100px){
      .wrap{ grid-template-columns: 1fr; }
      .panelBody{ grid-template-rows: 360px auto; }
    }

    @media (max-width: 640px){
      :root{
        --gap: 10px;
        --algoColW: 50px;
        --algoGap: 10px;
        --maxW: 980px;
      }
      .title .big{ font-size: 16px; }
      .actions{ gap:8px; justify-content:flex-start; }
      .pill{ font-size: 11px; padding: 6px 8px; }
      .btn{ padding: 10px 10px; font-size: 13px; border-radius: 14px; }

      .mat{ min-height: 360px; }

      .algoBox{ height: auto; min-height: 280px; }

      .digitsCol{ font-size: 32px; }
      .minus{ font-size: 24px; }
      .resBox{ height: 48px; font-size: 26px; border-radius: 14px; }

      .stepTitle{ font-size: 26px; }
      .stepText{ font-size: 16px; }
      .stepEq{ font-size: 16px; }
      .miniBox{ height: 40px; font-size: 22px; }

      .eq{ font-size: clamp(22px, 7vw, 38px); gap: 8px; }
      .ansPill{ height: 46px; font-size: 28px; border-radius: 14px; }

      .credit{
        position: static;
        padding: 10px 12px 14px;
        text-align: right;
        pointer-events:none;
      }
      .childGrid{ grid-template-columns: 1fr; }
      .randRow{ grid-template-columns: 1fr; }
      .rowBtns{ justify-content:flex-start; }
    }
  </style>

  <script src="https://cdn.counter.dev/script.js"
          data-id="825e93b6-ce99-40ef-8bcc-125f13297433"
          data-utcoffset="8"></script>
</head>

<body>
  <div class="topbar">
    <div class="title">
      <span class="big">Money Subtraction</span>
    </div>

    <div class="actions">
      <div class="pill"><span>A:</span><strong id="pillA">$31.60</strong></div>
      <div class="pill"><span>B:</span><strong id="pillB">$20.90</strong></div>
      <button class="btn" id="btnReset">â†º Reset</button>
      <button class="btn primary" id="btnNext">Next Step â–¶</button>
      <button class="btn" id="btnDone" disabled>Done âœ“</button>
    </div>
  </div>

  <div class="wrap">
    <section class="card leftCard">
      <div class="cardHead">
        <div>
          <div class="h" id="prompt">(a) Subtract $20.90 from $31.60.</div>
          <div class="sub">
            Click <b>Next Step</b> to subtract from the <b>lowest</b> place value to the <b>highest</b>.
If a place can subtract, subtract <b>immediately</b>. If not, <b>borrow 1</b> from the next left column (value Ã—10), then subtract.
<br/><b>Rule:</b> the ones digit of cents is always <b>0 or 5</b>.

            <br/><b>Rule:</b> the ones digit of cents is always <b>0 or 5</b>.
          </div>
        </div>
      </div>

      <div class="matWrap">
        <div class="mat" id="mat">
          <div class="cols" id="cols"></div>
          <div class="zones" id="zones"></div>
          <div class="dotSep" id="dotSep"></div>
        </div>
      </div>

      <div class="eqBar">
        <div class="eq">
          <span id="eqA">$31.60</span>
          <span>âˆ’</span>
          <span id="eqB">$20.90</span>
          <span>=</span>
          <span class="ansPill" id="eqAns">?</span>
        </div>
        <div class="eqHint" id="eqHint">Click Next Step</div>
      </div>
    </section>

    <aside class="card" id="teachCard">
      <div class="panelHead">
        <div class="h">Teaching Panel</div>
        <div class="small">Rename â†’ Subtract</div>
      </div>

      <div class="panelBody">
        <div class="algoBox">
          <div class="algoFit" id="algoFit">
            <div class="pvLabels" id="pvLabels"></div>

            <div class="stack">
              <div></div>
              <div class="renameRow" id="renameRow"></div>

              <div></div>
              <div class="digitsCol" id="rowA"></div>

              <div class="minus">âˆ’</div>
              <div class="digitsCol" id="rowB"></div>

              <div></div>
              <div class="barLine"></div>

              <div></div>
              <div class="resultRow" id="resRow"></div>
            </div>
          </div>
        </div>

        <div class="lowerPanel" id="lowerPanel">
          <div class="stepCard" id="stepCard">
            <div class="stepTitle" id="stepTitle">STEP 1</div>
            <div class="stepText" id="stepText">Subtract the ones of cents.</div>
            <div class="stepEq">
              <span id="stepL">?</span>
              <span>=</span>
              <span class="miniBox mystery" id="stepAns">?</span>
            </div>
          </div>

          <div class="childPanel" id="childPanel">
            <div class="childTitleRow">
              <div class="childTitle">ðŸ§’ Child Try-It Panel</div>
              <div class="childBadge">Try: <span id="childEq">$31.60 âˆ’ $20.90</span></div>
            </div>

            <div class="childGrid">
              <div>
                <label>Your answer</label>
                <input id="childAns" type="text" inputmode="decimal" placeholder="$8 or $8.00"/>
              </div>
              <button class="btn primary" id="btnChildCheck">Check âœ…</button>
            </div>

            <div class="childMsg" id="childMsg"></div>
          </div>

          <div class="teacherWrap">
            <div class="fields">
              <div>
                <label>Amount A (0â€“999.95)</label>
                <input id="inA" type="text" inputmode="decimal" value="31.60"/>
              </div>
              <div>
                <label>Amount B (0â€“999.95)</label>
                <input id="inB" type="text" inputmode="decimal" value="20.90"/>
              </div>
            </div>

            <div class="randRow">
              <div>
                <label>Random range</label>
                <select id="rangeSel">
                  <option value="20">Up to $20.00</option>
                  <option value="50">Up to $50.00</option>
                  <option value="100" selected>Up to $100.00</option>
                  <option value="200">Up to $200.00</option>
                  <option value="500">Up to $500.00</option>
                  <option value="999">Up to $999.95</option>
                </select>
              </div>
              <button class="btn" id="btnRandom">ðŸŽ² Random Amounts</button>
            </div>

            <div class="fields">
              <div>
                <label>Rename focus (for Random)</label>
                <select id="renameMode">
                  <option value="any" selected>Any (Auto)</option>
                  <option value="none">No renaming (no borrowing)</option>
                  <option value="cT">Renaming ten cents (10c â†’ 5c)</option>
                  <option value="O">Renaming one dollar ($1 â†’ 10c)</option>
                  <option value="T">Renaming ten dollar ($10 â†’ $1)</option>
                  <option value="H">Renaming hundred dollar ($100 â†’ $10)</option>
                  <option value="across0">Renaming across zeros</option>
                </select>
              </div>

              <div id="noRenameBox" style="display:none;">
                <label>Step order (No renaming only)</label>
                <select id="subOrder">
                  <option value="centsFirst" selected>Subtract cents â†’ then dollars</option>
                  <option value="dollarsFirst">Subtract dollars â†’ then cents</option>
                </select>
              </div>
            </div>

            <div class="rowBtns">
              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn primary" id="btnApply">Apply</button>
                <button class="btn" id="btnSwap">Swap A/B</button>
              </div>
            </div>

            <div class="noteErr" id="errBox"></div>
            <div style="font-size:12px; color:var(--muted); font-weight:900;">
              Tip: Start from the lowest place. If you can subtract, subtract immediately. If not, borrow 1 from the next left column (Ã—10), then subtract.

            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div class="credit">Designed by Lim Kim Sze Â© 2026</div>
  <div class="animLayer" id="animLayer"></div>
  <div class="confettiLayer" id="confettiLayer"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // Places:
  // H=$100, T=$10, O=$1, cT=10c, cO=ones of cents (0 or 5 only)
  const PLACES_ASC  = ["cO","cT","O","T","H"];
  const PLACES_DESC = ["H","T","O","cT","cO"];

  const PLACE_META = {
    H:  { label:"$100", short:"$100", tint:0 },
    T:  { label:"$10",  short:"$10",  tint:1 },
    O:  { label:"$1",   short:"$1",   tint:2 },
    cT: { label:"10c",  short:"10c",  tint:3 },
    cO: { label:"5c",   short:"5c",   tint:4 },
  };

  const ui = {
    pillA: $("pillA"), pillB: $("pillB"),
    eqA: $("eqA"), eqB: $("eqB"), eqAns: $("eqAns"), eqHint: $("eqHint"),
    prompt: $("prompt"),

    inA: $("inA"), inB: $("inB"),
    rangeSel: $("rangeSel"),
    renameMode: $("renameMode"),
    noRenameBox: $("noRenameBox"),
    subOrder: $("subOrder"),
    btnRandom: $("btnRandom"),
    btnApply: $("btnApply"), btnSwap: $("btnSwap"),

    btnReset: $("btnReset"), btnNext: $("btnNext"), btnDone: $("btnDone"),

    mat: $("mat"), cols: $("cols"), zones: $("zones"), dotSep: $("dotSep"),

    pvLabels: $("pvLabels"),
    renameRow: $("renameRow"),
    rowA: $("rowA"), rowB: $("rowB"), resRow: $("resRow"),
    algoFit: $("algoFit"),

    stepTitle: $("stepTitle"), stepText: $("stepText"), stepL: $("stepL"), stepAns: $("stepAns"),

    animLayer: $("animLayer"),
    confettiLayer: $("confettiLayer"),

    errBox: $("errBox"),

    childEq: $("childEq"),
    childAns: $("childAns"),
    btnChildCheck: $("btnChildCheck"),
    childMsg: $("childMsg"),

    teachCard: $("teachCard"),
    lowerPanel: $("lowerPanel"),
  };

  // ======= LION SVG =======
  const LION_SVG = `
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120" aria-hidden="true">
    <g fill="none" stroke="#0f172a" stroke-width="6" stroke-linecap="round" stroke-linejoin="round">
      <path d="M60 18c-20 0-36 16-36 36 0 22 14 40 36 40s36-18 36-40c0-20-16-36-36-36z"/>
      <path d="M38 48c-10-2-16-10-16-20 10 2 18 8 22 16"/>
      <path d="M82 48c10-2 16-10 16-20-10 2-18 8-22 16"/>
      <path d="M48 62c4 4 8 6 12 6s8-2 12-6"/>
      <path d="M56 74c2 2 4 3 4 3s2-1 4-3"/>
      <circle cx="46" cy="56" r="2"/>
      <circle cx="74" cy="56" r="2"/>
    </g>
  </svg>`;

  // ======= AUDIO =======
  let audioCtx = null;
  function ensureAudio(){
    if (audioCtx) return audioCtx;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return null;
    audioCtx = new Ctx();
    return audioCtx;
  }
  function resumeAudioIfNeeded(){
    const ctx = ensureAudio();
    if (!ctx) return;
    if (ctx.state === "suspended") ctx.resume().catch(()=>{});
  }
  window.addEventListener("pointerdown", resumeAudioIfNeeded, { passive:true });

  function playClick(){
    const ctx = ensureAudio(); if (!ctx) return;
    const t0 = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(760, t0);
    o.frequency.exponentialRampToValueAtTime(260, t0 + 0.03);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.22, t0 + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.07);
    o.connect(g).connect(ctx.destination);
    o.start(t0);
    o.stop(t0 + 0.08);
  }
  function playSwoosh(){
    const ctx = ensureAudio(); if (!ctx) return;
    const t0 = ctx.currentTime;
    const dur = 0.28;
    const bufferSize = Math.floor(ctx.sampleRate * dur);
    const buf = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<bufferSize;i++){
      const x = i / bufferSize;
      const env = Math.sin(Math.PI * x);
      data[i] = (Math.random()*2-1) * env * 0.9;
    }
    const src = ctx.createBufferSource(); src.buffer = buf;
    const filter = ctx.createBiquadFilter();
    filter.type = "bandpass";
    filter.frequency.setValueAtTime(900, t0);
    filter.frequency.exponentialRampToValueAtTime(240, t0 + dur);
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.20, t0 + 0.05);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
    src.connect(filter).connect(g).connect(ctx.destination);
    src.start(t0);
    src.stop(t0 + dur + 0.02);
  }

  // ======= Confetti =======
  function burstConfetti(){
    const layer = ui.confettiLayer;
    if (!layer) return;
    layer.innerHTML = "";

    const W = window.innerWidth || 800;
    const H = window.innerHeight || 600;
    const count = 120;

    for (let i=0;i<count;i++){
      const p = document.createElement("div");
      const size = 6 + Math.random()*8;
      const left = Math.random() * W;
      const top = -20 - Math.random()*H*0.25;

      p.style.position = "absolute";
      p.style.left = left + "px";
      p.style.top = top + "px";
      p.style.width = size + "px";
      p.style.height = (size * (0.7 + Math.random()*0.9)) + "px";
      p.style.borderRadius = (Math.random() < 0.25) ? "999px" : "3px";
      p.style.opacity = "0.95";
      p.style.transform = `rotate(${Math.random()*360}deg)`;
      const hue = Math.floor(Math.random()*360);
      p.style.background = `hsl(${hue} 90% 55%)`;

      layer.appendChild(p);

      const drift = (Math.random()*2 - 1) * W * 0.22;
      const endY = H + 80 + Math.random()*120;
      const rot = (Math.random()*2 - 1) * 980;
      const dur = 1100 + Math.random()*900;
      const delay = Math.random()*120;

      p.animate([
        { transform: `translate(0px, 0px) rotate(0deg)`, opacity: 1 },
        { transform: `translate(${drift}px, ${endY}px) rotate(${rot}deg)`, opacity: 1 }
      ], { duration: dur, delay, easing:"cubic-bezier(.2,.9,.2,1)", fill:"forwards" });

      p.animate([{ opacity: 1 },{ opacity: 0 }],
        { duration: 450, delay: delay + dur - 350, easing:"ease-out", fill:"forwards" });
    }
    setTimeout(() => { layer.innerHTML = ""; }, 2400);
  }

  function pulseTeachingPanel(){
    ui.teachCard.classList.remove("pulseTeacher");
    ui.lowerPanel.classList.remove("pulseTeacher");
    void ui.teachCard.offsetWidth;
    ui.teachCard.classList.add("pulseTeacher");
    ui.lowerPanel.classList.add("pulseTeacher");
    setTimeout(() => {
      ui.teachCard.classList.remove("pulseTeacher");
      ui.lowerPanel.classList.remove("pulseTeacher");
    }, 1800);
  }

  // ======= Helpers =======
  // Step order: only meaningful when NO RENAMING is selected
  const ORDER_CENTS_FIRST   = ["cO","cT","O","T","H"]; // default
  const ORDER_DOLLARS_FIRST = ["O","T","H","cO","cT"];

  function isNoRenaming(){
    return (ui.renameMode?.value === "none");
  }

  function getPlaceOrder(){
    const mode = (ui.renameMode?.value || "any");
    if (mode === "none"){
      const ord = (ui.subOrder?.value || "centsFirst");
      return (ord === "dollarsFirst") ? ORDER_DOLLARS_FIRST : ORDER_CENTS_FIRST;
    }
    // With renaming, we always follow standard lowestâ†’highest for correct borrowing
    return ORDER_CENTS_FIRST;
  }

  function cssVar(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || "ease";
  }
  function cssMs(name){
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    if (v.endsWith("ms")) return parseFloat(v);
    if (v.endsWith("s")) return parseFloat(v) * 1000;
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : 900;
  }
  function clampInt(n, min, max){
    let x = parseInt(String(n),10);
    if (!Number.isFinite(x)) x = 0;
    x = Math.floor(x);
    return Math.max(min, Math.min(max, x));
  }

  // Money parsing/formatting (cents int). Enforce cents ones digit 0 or 5.
  function normalizeMoneyInput(raw){
    raw = String(raw ?? "").trim();
    raw = raw.replace(/^\$/,"").replace(/,/g,"");
    if (!raw) return 0;

    const m = raw.match(/^(\d{1,3})(?:\.(\d{0,2}))?$/);
    if (!m) return null;

    let dollars = clampInt(m[1], 0, 999);
    let dec = (m[2] ?? "");
    if (dec.length === 0) dec = "00";
    if (dec.length === 1) dec = dec + "0";
    let cents = clampInt(dec, 0, 99);

    // snap to nearest 5 cents
    cents = Math.round(cents / 5) * 5;
    if (cents === 100){ dollars += 1; cents = 0; }
    dollars = Math.min(dollars, 999);

    return dollars*100 + cents;
  }

  // strict child input: must start with $ and be $8 or $8.00 (not $8.0)
  function parseChildMoneyStrict(raw){
    raw = String(raw ?? "").trim().replace(/,/g,"");
    if (!raw.startsWith("$")) return null;

    const m = raw.match(/^\$(\d{1,3})(?:\.(\d{2}))?$/);
    if (!m) return null;

    const dollars = clampInt(m[1], 0, 999);
    const dec = (m[2] ?? "00");
    const cents = clampInt(dec, 0, 99);

    let snapped = Math.round(cents / 5) * 5;
    let d2 = dollars;
    if (snapped === 100){ d2 += 1; snapped = 0; }
    d2 = Math.min(d2, 999);

    return d2*100 + snapped;
  }

  function formatMoney(cents){
    cents = Math.max(0, Math.round(cents));
    const d = Math.floor(cents/100);
    const c = cents%100;
    return "$" + d + "." + String(c).padStart(2,"0");
  }

  function splitMoneyDigits(cents){
    cents = Math.max(0, Math.round(cents));
    const dollars = Math.floor(cents/100);
    const c = cents%100;

    const H = Math.floor(dollars/100)%10;
    const T = Math.floor(dollars/10)%10;
    const O = dollars%10;

    const cT = Math.floor(c/10);
    const cO = c%10; // 0 or 5

    return { H, T, O, cT, cO };
  }

  // ======= TOKEN BUILDERS (coins/notes with lion) =======
  function makeLionEl(){
    const wrap = document.createElement("div");
    wrap.className = "lionStamp";
    wrap.innerHTML = LION_SVG;
    return wrap;
  }

  function makeNoteToken(placeKey){
    const el = document.createElement("div");
    el.className = "tokenNote";
    el.dataset.place = placeKey;

    el.style.borderRadius = "18px";
    el.style.width = "140px";
    el.style.height = "74px";
    el.style.border = "2px solid rgba(15,23,42,.16)";
    el.style.boxShadow = "0 10px 18px rgba(2,6,23,.10)";
    el.style.background =
      (placeKey==="T")
        ? `radial-gradient(circle at 18% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
           linear-gradient(135deg, rgba(251,191,36,.18), rgba(139,92,246,.12))`
        : `radial-gradient(circle at 18% 30%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
           linear-gradient(135deg, rgba(34,197,94,.18), rgba(14,165,233,.14))`;

    const inner = document.createElement("div");
    inner.style.position = "absolute";
    inner.style.inset = "10px";
    inner.style.borderRadius = "14px";
    inner.style.border = "2px dotted rgba(15,23,42,.16)";
    inner.style.pointerEvents = "none";
    inner.style.zIndex = "1";
    el.appendChild(inner);

    el.appendChild(makeLionEl());

    const face = document.createElement("div");
    face.className = "noteFace";
    face.innerHTML = `<div style="font-size:18px;">${PLACE_META[placeKey].short}</div><small>Singapore</small>`;
    el.appendChild(face);

    return el;
  }

  function makeCoinTokenCents(className, labelTop){
    const el = document.createElement("div");
    el.className = "token";
    const coin = document.createElement("div");
    coin.className = `coin ${className}`;
    const ring = document.createElement("div");
    ring.className = "ring";
    const inner = document.createElement("div");
    inner.className = "inner";
    inner.innerHTML = `<div style="text-align:center; line-height:1.05;">
        <span>${labelTop}</span>
        <small>cent</small>
      </div>`;
    coin.appendChild(ring);
    coin.appendChild(inner);
    el.appendChild(coin);
    return el;
  }

  function makeDollarOneToken(){
    const el = document.createElement("div");
    el.className = "tokenNote tokenCoin1";
    el.dataset.place = "O";
    const face = document.createElement("div");
    face.className = "coinOct";
    face.style.width = "74px";
    face.style.height = "74px";
    face.innerHTML = `<div style="text-align:center; line-height:1.05;">
        <div style="font-size:18px; font-weight:1000;">$1</div>
        <small>coin</small>
      </div>`;
    el.appendChild(face);
    return el;
  }

  function makeTokenEl(placeKey){
    if (placeKey === "H" || placeKey === "T") return makeNoteToken(placeKey);
    if (placeKey === "O") return makeDollarOneToken();
    if (placeKey === "cT") {
      const el = makeCoinTokenCents("c10", "10");
      el.dataset.place = "cT";
      return el;
    }
    const el = makeCoinTokenCents("c5", "5");
    el.dataset.place = "cO";
    return el;
  }

  // ======= Pile layout helpers =======
  function ensureTwoColStructure(pileEl){
    // âœ… now: keep a single vertical stack container (colL). colR exists but unused/hidden.
    if (pileEl.querySelector(".colL")) return;
    const L = document.createElement("div"); L.className = "colL";
    const R = document.createElement("div"); R.className = "colR";
    pileEl.appendChild(L); pileEl.appendChild(R);
  }
  function putTokenTwoCol(pileEl, tokenEl){
    ensureTwoColStructure(pileEl);
    const L = pileEl.querySelector(".colL");
    // âœ… always stack vertically in ONE column
    L.appendChild(tokenEl);
  }
  function flattenTokens(pileEl){
    const L = pileEl.querySelector(".colL");
    const R = pileEl.querySelector(".colR");
    const a = L ? Array.from(L.children) : [];
    const b = R ? Array.from(R.children) : [];
    return [...a, ...b].filter(n => n && n.classList);
  }
  function repackPile(pileEl, placeKey){
    const tokens = flattenTokens(pileEl);
    pileEl.innerHTML = "";
    pileEl.dataset.place = placeKey;
    pileEl.className = "pile pileTwoCol";
    ensureTwoColStructure(pileEl);
    for (const t of tokens) putTokenTwoCol(pileEl, t);
  }

  function fillPile(pileEl, placeKey, count){
    pileEl.innerHTML = "";
    pileEl.dataset.place = placeKey;
    count = clampInt(count, 0, 99);
    pileEl.className = "pile pileTwoCol";
    ensureTwoColStructure(pileEl);
    for (let i=0;i<count;i++){
      const tok = makeTokenEl(placeKey);
      tok.dataset.place = placeKey;
      putTokenTwoCol(pileEl, tok);
    }
  }

  function fitAllPiles(){
    const zones = ui.zones.querySelectorAll(".zone");
    zones.forEach(z => {
      const fit = z.querySelector(".fitBox");
      if (!fit) return;
      fit.style.transform = "scale(1)";
      const availW = z.clientWidth - 10;
      const availH = z.clientHeight - 10;
      const contentW = fit.scrollWidth;
      const contentH = fit.scrollHeight;
      if (contentW < 1 || contentH < 1) return;
      const s = Math.min(1, availW / contentW, availH / contentH);
      fit.style.transform = `scale(${s})`;
    });
  }

  // âœ… FIX 3: safer fitAlgo (use bbox after DOM settles; avoids 0-width measurements)
  function fitAlgo(){
    const el = ui.algoFit;
    const box = el.parentElement;

    el.style.transform = "scale(1)";

    requestAnimationFrame(() => {
      const availW = box.clientWidth - 14;
      const availH = box.clientHeight - 14;

      const r = el.getBoundingClientRect();
      const w = r.width;
      const h = r.height;

      if (!w || !h) return;

      const s = Math.min(1, availW / w, availH / h);
      el.style.transform = `scale(${s})`;
    });
  }

  // ======= State =======
  let A = 3160;
  let B = 2090;
  const zoneMap = { work:{} };

  let actions = [];
  let actionIndex = 0;
  let busy = false;

  let renameDigits = { H:null, T:null, O:null, cT:null, cO:null };
  let strikeDigits = { H:false, T:false, O:false, cT:false, cO:false };

  let resultDigits = { H:null, T:null, O:null, cT:null, cO:null };

  function showErr(msg){
    ui.errBox.style.display = msg ? "block" : "none";
    ui.errBox.textContent = msg || "";
  }

  function enforceSubRule(){
    if (A < B){
      const tmp = A; A = B; B = tmp;
      ui.inA.value = formatMoney(A).replace(/^\$/,"");
      ui.inB.value = formatMoney(B).replace(/^\$/,"");
      showErr("For subtraction, A should be â‰¥ B. Swapped automatically.");
    }
  }

  // âœ… Build actions: borrow only if needed for each place, then subtract immediately.
  function buildActions(placeOrder){
    const order = Array.isArray(placeOrder) ? placeOrder.slice() : PLACES_ASC.slice();
    const work = splitMoneyDigits(A);
    const sub  = splitMoneyDigits(B);

    const acts = [];
    const noRename = isNoRenaming();

    // Borrow adjacency must always follow true place value order (cO<-cT<-O<-T<-H)
    const BASE = ["cO","cT","O","T","H"];

    for (let oi = 0; oi < order.length; oi++){
      const p = order[oi];

      const fromVal0 = work[p] ?? 0;
      const subVal0  = sub[p] ?? 0;

      // NO RENAMING: if cannot subtract, stop and block.
      if (noRename && fromVal0 < subVal0){
        acts.push({
          type:"block",
          place: p,
          fromVal: fromVal0,
          subVal: subVal0,
          msg: `Cannot subtract in ${PLACE_META[p].label} without renaming. Change amounts or allow renaming.`
        });
        break;
      }

      // With renaming allowed: borrow only when needed (standard rule)
      if (!noRename){
        const piBase = BASE.indexOf(p);
        while ((work[p] ?? 0) < (sub[p] ?? 0)){
          let donorIndex = -1;
          for (let j = piBase + 1; j < BASE.length; j++){
            const k = BASE[j];
            if ((work[k] ?? 0) > 0){ donorIndex = j; break; }
          }
          if (donorIndex === -1) break;

          for (let j = donorIndex; j > piBase; j--){
            const high = BASE[j];
            const low  = BASE[j-1];

            const highBefore = work[high] ?? 0;
            const lowBefore  = work[low] ?? 0;

            work[high] = highBefore - 1;
            // Digit math regrouping stays Ã—10 (visual token split handles 10c->two 5c).
            work[low]  = lowBefore + 10;

            acts.push({
              type:"borrow",
              from: high,
              to: low,
              highBefore,
              lowBefore,
              highAfter: work[high],
              lowAfter: work[low],
            });
          }
        }
      }

      // Subtract immediately once possible
      const fromVal = work[p] ?? 0;
      const subVal  = sub[p] ?? 0;
      const resVal  = fromVal - subVal;

      acts.push({ type:"subtract", place:p, fromVal, subVal, resVal });
      work[p] = resVal;
    }

    return acts;
  }

  function actionsMatchRenameMode(acts, mode){
    if (!mode || mode === "any") return true;
    const borrows = acts.filter(x => x.type === "borrow");

    if (mode === "none"){
      return borrows.length === 0;
    }
    if (mode === "across0"){
      return borrows.some(b => (b.lowBefore ?? 1) === 0);
    }
    return borrows.some(b => b.from === mode);
  }

  // ======= Algorithm UI rendering =======
  function renderAlgorithm(){
    // labels
    ui.pvLabels.innerHTML = "";
    const mk = (txt, cls) => {
      const s = document.createElement("div");
      s.className = "lab " + (cls||"");
      s.textContent = txt;
      return s;
    };
    ui.pvLabels.appendChild(mk("", "blank"));
    ui.pvLabels.appendChild(mk("dollars", "dollars"));
    ui.pvLabels.appendChild(mk("", "blank"));
    ui.pvLabels.appendChild(mk("", "blank"));
    ui.pvLabels.appendChild(mk("", "blank"));
    ui.pvLabels.appendChild(mk("coins", "coins"));
    ui.pvLabels.appendChild(mk("", "blank"));

    const digitsA = splitMoneyDigits(A);
    const digitsB = splitMoneyDigits(B);

    const buildRow = (container, digits, strikeMap=null) => {
      container.innerHTML = "";
      const mkSpan = (txt, cls="") => {
        const s = document.createElement("span");
        s.textContent = txt;
        if (cls) s.className = cls;
        return s;
      };

      // Hide H box when H=0. Hide T box when H=0 and T=0. (No leading 0 boxes.)
      const hideH = (digits.H === 0);
      const hideT = (digits.H === 0 && digits.T === 0);

      container.appendChild(mkSpan("$","moneySym"));

      // H
      if (hideH){
        container.appendChild(mkSpan("", "blank"));
      } else {
        const sH = mkSpan(String(digits.H));
        if (strikeMap?.H) sH.classList.add("strike");
        container.appendChild(sH);
      }

      // T
      if (hideT){
        container.appendChild(mkSpan("", "blank"));
      } else {
        const sT = mkSpan(String(digits.T));
        if (strikeMap?.T) sT.classList.add("strike");
        container.appendChild(sT);
      }

      // O always shown
      const sO = mkSpan(String(digits.O));
      if (strikeMap?.O) sO.classList.add("strike");
      container.appendChild(sO);

      // dot + cents always shown
      container.appendChild(mkSpan(".","dotCell"));
      const sCT = mkSpan(String(digits.cT)); if (strikeMap?.cT) sCT.classList.add("strike");
      const sCO = mkSpan(String(digits.cO)); if (strikeMap?.cO) sCO.classList.add("strike");
      container.appendChild(sCT);
      container.appendChild(sCO);
    };

    buildRow(ui.rowA, digitsA, strikeDigits);
    buildRow(ui.rowB, digitsB, null);

    // rename row
    ui.renameRow.innerHTML = "";
    const mkR = (txt, cls="blank") => {
      const s = document.createElement("span");
      s.textContent = txt;
      s.className = cls;
      return s;
    };
    ui.renameRow.appendChild(mkR("$","moneyCell"));
    ui.renameRow.appendChild(mkR(renameDigits.H ?? "", (renameDigits.H==null)?"blank":"renamed"));
    ui.renameRow.appendChild(mkR(renameDigits.T ?? "", (renameDigits.T==null)?"blank":"renamed"));
    ui.renameRow.appendChild(mkR(renameDigits.O ?? "", (renameDigits.O==null)?"blank":"renamed"));
    ui.renameRow.appendChild(mkR(".","dotCell"));
    ui.renameRow.appendChild(mkR(renameDigits.cT ?? "", (renameDigits.cT==null)?"blank":"renamed"));
    ui.renameRow.appendChild(mkR(renameDigits.cO ?? "", (renameDigits.cO==null)?"blank":"renamed"));

    // result row
    ui.resRow.innerHTML = "";

    const mkBox = (txt, cls="", id="") => {
      const d = document.createElement("div");
      d.className = "resBox " + cls;
      d.textContent = (txt === "" ? "\u00A0" : String(txt)); // NBSP keeps box visible
      if (id) d.id = id;
      return d;
    };

    ui.resRow.appendChild(mkBox("$","blankCell"));

    // dollars (NO leading 0 text, but boxes stay visible if you want later; currently we ghost)
    const resH = resultDigits.H;
    const resT = resultDigits.T;
    const resO = resultDigits.O;

    let txtH = (resH == null) ? "?" : String(resH);
    let txtT = (resT == null) ? "?" : String(resT);
    let txtO = (resO == null) ? "?" : String(resO);

    const allKnownD = (resH != null && resT != null && resO != null);
    if (allKnownD){
      if (resH === 0) txtH = "";
      if (resH === 0 && resT === 0) txtT = "";
      if (resH === 0 && resT === 0 && resO === 0) txtO = "0";
    }

    const clsH = (resH == null) ? "mystery" : (txtH === "" ? "ghost0" : "");
    const clsT = (resT == null) ? "mystery" : (txtT === "" ? "ghost0" : "");
    const clsO = (resO == null) ? "mystery" : "";

    ui.resRow.appendChild(mkBox(txtH, clsH, "res_H"));
    ui.resRow.appendChild(mkBox(txtT, clsT, "res_T"));
    ui.resRow.appendChild(mkBox(txtO, clsO, "res_O"));

    // dot + cents ALWAYS present
    ui.resRow.appendChild(mkBox(".","dotCell"));

    const resCT = resultDigits.cT;
    const resCO = resultDigits.cO;

    ui.resRow.appendChild(mkBox(resCT == null ? "?" : String(resCT), resCT == null ? "mystery" : "", "res_cT"));
    ui.resRow.appendChild(mkBox(resCO == null ? "?" : String(resCO), resCO == null ? "mystery" : "", "res_cO"));

    requestAnimationFrame(fitAlgo);
  }

  function resetProcess(){
    actions = buildActions(getPlaceOrder());
    actionIndex = 0;

    renameDigits = { H:null, T:null, O:null, cT:null, cO:null };
    strikeDigits = { H:false, T:false, O:false, cT:false, cO:false };
    resultDigits = { H:null, T:null, O:null, cT:null, cO:null };

    ui.eqAns.textContent = "?";
    ui.eqHint.textContent = "Click Next Step";
    ui.btnDone.disabled = true;
    ui.btnNext.disabled = false;

    renderAlgorithm();
    renderStepCard();
    resetChildPanel();
  }

  function renderStepCard(){
    const a = actions[actionIndex];
    if (!a){
      ui.stepTitle.textContent = "DONE";
      ui.stepText.textContent = "All steps completed.";
      ui.stepL.textContent = "Great!";
      ui.stepAns.textContent = "âœ“";
      ui.stepAns.classList.remove("mystery");
      return;
    }

    ui.stepTitle.textContent = `STEP ${actionIndex + 1}`;

    if (a.type === "block"){
      ui.stepText.textContent = a.msg;
      ui.stepL.textContent = `${a.fromVal} âˆ’ ${a.subVal} (not possible without renaming)`;
      ui.stepAns.textContent = "âœ•";
      ui.stepAns.classList.remove("mystery");
      ui.eqHint.textContent = "No renaming: choose different amounts or allow renaming.";
      ui.btnNext.disabled = true;
      ui.btnDone.disabled = true;
      return;
    }

    if (a.type === "borrow"){
      const fromLabel = PLACE_META[a.from].label;
      const toLabel   = PLACE_META[a.to].label;
      ui.stepText.textContent = `Rename (borrow) from ${fromLabel} to ${toLabel}.`;
      ui.stepL.textContent = `${a.highBefore} (${fromLabel}) â†’ ${a.highAfter} and ${a.lowBefore} (${toLabel}) â†’ ${a.lowAfter}`;
      ui.stepAns.textContent = "âœ“";
      ui.stepAns.classList.remove("mystery");
    } else {
      const pLabel = PLACE_META[a.place].label;
      ui.stepText.textContent = `Subtract in the ${pLabel} place.`;
      ui.stepL.textContent = `${a.fromVal} âˆ’ ${a.subVal} =`;
      ui.stepAns.textContent = "?";
      ui.stepAns.classList.add("mystery");
    }
  }

  function resetChildPanel(){
    ui.childEq.textContent = `${formatMoney(A)} âˆ’ ${formatMoney(B)}`;
    ui.childAns.value = "";
    ui.childMsg.className = "childMsg";
    ui.childMsg.style.display = "none";
    ui.childMsg.textContent = "";
  }

  function setChildMsg(kind, text){
    ui.childMsg.className = "childMsg " + kind;
    ui.childMsg.textContent = text;
    ui.childMsg.style.display = "block";
  }

  function checkChildAnswer(){
    resumeAudioIfNeeded();
    const raw = String(ui.childAns.value ?? "").trim();
    if (!raw){
      setChildMsg("bad", "Type your answer first ðŸ™‚");
      playClick();
      return;
    }
    const guess = parseChildMoneyStrict(raw);
    if (guess === null){
      setChildMsg("bad", "Please type $8 or $8.00 (must start with $ and 0 or 2 decimal places).");
      playClick();
      return;
    }
    const correct = A - B;

    if (guess === correct){
      setChildMsg("ok", "ðŸŽ‰ Correct! Well done!");
      playClick();
      burstConfetti();
    } else {
      setChildMsg("bad", "Not yet. Follow the Teaching Panel steps (Rename â†’ Subtract), then try again.");
      playClick();
      pulseTeachingPanel();
    }
  }

  // ======= Mat rendering (A only) =======
  function renderMat(){
    const cols = PLACES_DESC.slice(); // H T O cT cO
    ui.cols.style.setProperty("--cols", cols.length);
    ui.zones.style.setProperty("--cols", cols.length);

    ui.cols.innerHTML = "";
    cols.forEach((k) => {
      const d = document.createElement("div");
      d.className = "col tint" + (PLACE_META[k].tint ?? 0);
      ui.cols.appendChild(d);
    });

    ui.mat.querySelectorAll(".vSep").forEach(el => el.remove());
    for (let i=1;i<cols.length;i++){
      const v = document.createElement("div");
      v.className = "vSep";
      v.style.left = `calc(${(i/cols.length)*100}% - 1px)`;
      ui.mat.appendChild(v);
    }

    const dotLeftPct = (3/cols.length)*100;
    ui.dotSep.style.left = `calc(${dotLeftPct}% - 9px)`;

    ui.zones.innerHTML = "";
    zoneMap.work = {};

    const makeZone = (placeKey) => {
      const z = document.createElement("div");
      z.className = "zone";
      z.dataset.place = placeKey;

      const inner = document.createElement("div");
      inner.className = "zoneInner";

      const fit = document.createElement("div");
      fit.className = "fitBox";

      const pile = document.createElement("div");
      pile.className = "pile pileTwoCol";
      pile.dataset.place = placeKey;
      ensureTwoColStructure(pile);

      fit.appendChild(pile);
      inner.appendChild(fit);
      z.appendChild(inner);

      zoneMap.work[placeKey] = { zone:z, pile };
      return z;
    };

    cols.forEach(k => ui.zones.appendChild(makeZone(k)));

    const da = splitMoneyDigits(A);

    // cO is in cents (0 or 5 normally). Tokens are 5c coins.
    cols.forEach(k => {
      let count = da[k] ?? 0;

      // âœ… number of 5c coins = cO cents Ã· 5
      if (k === "cO") count = Math.round((da.cO ?? 0) / 5);

      fillPile(zoneMap.work[k].pile, k, count);
    });

    requestAnimationFrame(() => {
      fitAllPiles();
      fitAlgo();
    });
  }

  // ======= Animations: borrow and cross-out remove =======
  async function borrowSplit(fromPlace, toPlace){
    const fromPile = zoneMap.work[fromPlace].pile;
    const toPile   = zoneMap.work[toPlace].pile;

    const donors = Array.from(fromPile.querySelectorAll(`[data-place="${fromPlace}"]`));
    const donor = donors[donors.length-1];
    if (!donor) return;

    document.body.classList.add("animating");
    resumeAudioIfNeeded();
    playSwoosh();

    const fromRect = donor.getBoundingClientRect();
    donor.classList.add("movingHidden");

    const ghostDonor = document.createElement("div");
    ghostDonor.className = "ghost";
    ghostDonor.style.width = fromRect.width + "px";
    ghostDonor.style.height = fromRect.height + "px";
    ghostDonor.style.transform = `translate(${fromRect.left}px, ${fromRect.top}px)`;
    ghostDonor.innerHTML = donor.outerHTML;
    ui.animLayer.appendChild(ghostDonor);

    const c = { x: fromRect.left + fromRect.width/2, y: fromRect.top + fromRect.height/2 };

    await ghostDonor.animate([
      { transform:`translate(${fromRect.left}px, ${fromRect.top}px) scale(1)`, opacity: 1 },
      { transform:`translate(${c.x}px, ${c.y}px) scale(0.55)`, opacity: 1 }
    ], { duration: cssMs("--regroupDur"), easing: cssVar("--ease"), fill:"forwards" }).finished.catch(()=>{});

    playClick();

    await ghostDonor.animate([
      { opacity: 1 },
      { opacity: 0, transform: ghostDonor.style.transform + " scale(0.25)", filter:"blur(0.8px)" }
    ], { duration: 240, easing:"ease-in", fill:"forwards" }).finished.catch(()=>{});

    ghostDonor.remove();
    donor.remove();

    const newTokens = [];

    // âœ… Money rule:
    // 10c â†’ two 5c coins (NOT ten 5c coins)
    const factor = (fromPlace === "cT" && toPlace === "cO") ? 2 : 10;

    for (let i=0;i<factor;i++){
      const t = makeTokenEl(toPlace);
      t.dataset.place = toPlace;
      t.classList.add("movingHidden");
      putTokenTwoCol(toPile, t);
      newTokens.push(t);
    }

    repackPile(toPile, toPlace);
    repackPile(fromPile, fromPlace);
    fitAllPiles();

    resumeAudioIfNeeded();
    playSwoosh();

    const endRects = newTokens.map(t => t.getBoundingClientRect());
    const anims = [];

    for (let i=0;i<newTokens.length;i++){
      const er = endRects[i];
      const ghost = document.createElement("div");
      ghost.className = "ghost";
      ghost.style.width = er.width + "px";
      ghost.style.height = er.height + "px";
      ghost.innerHTML = newTokens[i].outerHTML;
      ui.animLayer.appendChild(ghost);

      const a = ghost.animate([
        { transform:`translate(${c.x}px, ${c.y}px) scale(0.55)`, opacity: 0.0 },
        { transform:`translate(${c.x}px, ${c.y}px) scale(0.55)`, opacity: 1.0, offset: 0.12 },
        { transform:`translate(${er.left}px, ${er.top}px) scale(1)`, opacity: 1.0 }
      ], { duration: cssMs("--moveDur"), easing: cssVar("--ease"), fill:"forwards" });

      anims.push(a.finished.catch(()=>{}).then(() => ghost.remove()));
    }

    await Promise.all(anims);

    newTokens.forEach(t => t.classList.remove("movingHidden"));
    repackPile(toPile, toPlace);
    fitAllPiles();

    document.body.classList.remove("animating");
  }

  async function crossOutAndRemove(placeKey, subVal){
    let count = clampInt(subVal, 0, 99);
    if (count <= 0) return;

    const pileWrap = zoneMap.work[placeKey];
    if (!pileWrap || !pileWrap.pile) return;
    const pile = pileWrap.pile;

    if (placeKey === "cO"){
      // âœ… remove subVal cents worth of 5c coins
      count = Math.round(count / 5);
      if (count <= 0) return;
    }

    const nodes = Array.from(pile.querySelectorAll(`.colL > [data-place="${placeKey}"], .colR > [data-place="${placeKey}"]`));
    const tokens = nodes.slice(-count);
    if (!tokens.length) return;

    document.body.classList.add("animating");
    resumeAudioIfNeeded();
    playSwoosh();

    const canAnimate = !!(HTMLElement.prototype.animate);
    if (!canAnimate){
      tokens.forEach(t => t.remove());
      repackPile(pile, placeKey);
      fitAllPiles();
      playClick();
      document.body.classList.remove("animating");
      return;
    }

    const anims = [];

    for (const t of tokens){
      const r = t.getBoundingClientRect();
      t.classList.add("movingHidden");

      const g = document.createElement("div");
      g.className = "ghost xout";
      g.style.width = r.width + "px";
      g.style.height = r.height + "px";
      g.style.transform = `translate(${r.left}px, ${r.top}px)`;
      g.style.opacity = "1";
      g.innerHTML = t.outerHTML;
      ui.animLayer.appendChild(g);

      const a = g.animate([
        { transform:`translate(${r.left}px, ${r.top}px) scale(1)`, opacity: 1 },
        { transform:`translate(${r.left}px, ${r.top}px) scale(0.92)`, opacity: 1, offset: 0.65 },
        { transform:`translate(${r.left}px, ${r.top}px) scale(0.82)`, opacity: 0 }
      ], { duration: 520, easing:"ease-in-out", fill:"forwards" });

      anims.push(
        a.finished.catch(()=>{}).then(() => {
          g.remove();
          t.remove();
        })
      );
    }

    await Promise.all(anims);

    repackPile(pile, placeKey);
    fitAllPiles();

    playClick();
    document.body.classList.remove("animating");
  }

  function revealResultDigit(placeKey){
    const d = splitMoneyDigits(A - B);
    resultDigits[placeKey] = d[placeKey];
  }

  function allResultRevealed(){
    return PLACES_DESC.every(k => resultDigits[k] !== null && resultDigits[k] !== undefined);
  }

  async function doNextStep(){
    if (busy) return;

    const a = actions[actionIndex];
    if (!a) return;

    // If blocked, do nothing
    if (a.type === "block"){
      renderStepCard();
      return;
    }

    busy = true;
    try{
      if (a.type === "borrow"){
        renameDigits[a.from] = a.highAfter;
        renameDigits[a.to]   = a.lowAfter;
        strikeDigits[a.from] = true;
        strikeDigits[a.to]   = true;

        renderAlgorithm();
        renderStepCard();

        await borrowSplit(a.from, a.to);

        actionIndex += 1;
        renderAlgorithm();
        renderStepCard();

        fitAllPiles();
        fitAlgo();
        return;
      }

      await crossOutAndRemove(a.place, a.subVal);

      revealResultDigit(a.place);

      ui.stepAns.textContent = String(a.resVal);
      ui.stepAns.classList.remove("mystery");

      actionIndex += 1;

      renderAlgorithm();
      renderStepCard();

      if (allResultRevealed()){
        ui.eqAns.textContent = formatMoney(A - B);
        ui.eqHint.textContent = "Done!";
        ui.btnDone.disabled = false;
        ui.btnNext.disabled = true;
        burstConfetti();
        playClick();
      }

      fitAllPiles();
      fitAlgo();
    }catch(err){
      console.error("doNextStep error:", err);
      ui.eqHint.textContent = "If it got stuck, tap Next Step again.";
    }finally{
      busy = false;
      document.body.classList.remove("animating");
    }
  }

  // ======= Random amounts =======
  function randInt(min, max){
    return Math.floor(min + Math.random() * (max - min + 1));
  }
  function randomMoneyUpTo(maxDollars){
    maxDollars = clampInt(maxDollars, 0, 999);
    const dollars = randInt(0, maxDollars);
    const centsT = randInt(0, 9);
    const centsO = (Math.random() < 0.5) ? 0 : 5;
    const cents = centsT*10 + centsO;
    return dollars*100 + cents;
  }

  // ======= Render all =======
  function renderAll(){
    enforceSubRule();

    ui.pillA.textContent = formatMoney(A);
    ui.pillB.textContent = formatMoney(B);
    ui.eqA.textContent   = formatMoney(A);
    ui.eqB.textContent   = formatMoney(B);
    ui.prompt.textContent = `(a) Subtract ${formatMoney(B)} from ${formatMoney(A)}.`;
    ui.childEq.textContent = `${formatMoney(A)} âˆ’ ${formatMoney(B)}`;

    renderMat();
    resetProcess();
  }

  // ======= UI Events =======
function randomNoRenamePair(maxDollars){
  // generate digits where A>=B for EACH place so subtraction never borrows
  // places: H,T,O,cT,cO  (cO must be 0 or 5; cT 0..9)
  const H1 = randInt(0, Math.floor(maxDollars/100));
  const T1 = randInt(0, 9);
  const O1 = randInt(0, 9);
  const cT1 = randInt(0, 9);
  const cO1 = (Math.random() < 0.5) ? 0 : 5;

  // choose B digits <= A digits in every place
  const H2 = randInt(0, H1);
  const T2 = randInt(0, T1);
  const O2 = randInt(0, O1);
  const cT2 = randInt(0, cT1);
  const cO2 = randInt(0, cO1); // if cO1=0, then cO2=0; if 5, then 0..5 but must end in 0/5
  const cO2fix = (cO2 >= 5) ? 5 : 0;

  const A = (H1*100 + T1*10 + O1)*100 + (cT1*10 + cO1);
  const B = (H2*100 + T2*10 + O2)*100 + (cT2*10 + cO2fix);

  return [A, B];
}
  

function syncNoRenameUI(){
    const on = isNoRenaming();
    if (ui.noRenameBox) ui.noRenameBox.style.display = on ? "block" : "none";
  }
  ui.renameMode.addEventListener("change", () => {
    syncNoRenameUI();
    renderAll(); // rebuild steps with the new mode/order
  });
  ui.subOrder?.addEventListener("change", () => {
    if (isNoRenaming()) renderAll();
  });

  ui.btnNext.addEventListener("click", () => doNextStep());
  ui.btnReset.addEventListener("click", () => renderAll());

  ui.btnApply.addEventListener("click", () => {
    showErr("");
    const a = normalizeMoneyInput(ui.inA.value);
    const b = normalizeMoneyInput(ui.inB.value);

    if (a === null || b === null){
      showErr("Please enter valid money amounts like 31.60 (2 d.p.).");
      return;
    }
    A = a; B = b;
    enforceSubRule();

    ui.inA.value = formatMoney(A).replace(/^\$/,"");
    ui.inB.value = formatMoney(B).replace(/^\$/,"");

    renderAll();
  });

  ui.btnSwap.addEventListener("click", () => {
    showErr("");
    const tmp = A; A = B; B = tmp;
    enforceSubRule();
    ui.inA.value = formatMoney(A).replace(/^\$/,"");
    ui.inB.value = formatMoney(B).replace(/^\$/,"");
    renderAll();
  });

  ui.btnRandom.addEventListener("click", () => {
    showErr("");
    const maxD = parseInt(ui.rangeSel.value || "100", 10);
    const mode = (ui.renameMode?.value || "any");
if (mode === "none"){
  const maxD = parseInt(ui.rangeSel.value || "100", 10);
  const [aa, bb] = randomNoRenamePair(maxD);
  A = aa; B = bb;
  enforceSubRule();
  ui.inA.value = formatMoney(A).replace(/^\$/,"");
  ui.inB.value = formatMoney(B).replace(/^\$/,"");
  renderAll();
  return;
}


    let a = 0, b = 0, ok = false;

    for (let tries=0; tries<800; tries++){
      let aa = randomMoneyUpTo(maxD);
      let bb = randomMoneyUpTo(maxD);
      if (aa < bb){ const t=aa; aa=bb; bb=t; }

      const savedA = A, savedB = B;
      A = aa; B = bb;
      enforceSubRule();
     const acts = buildActions(getPlaceOrder());
const match = actionsMatchRenameMode(acts, mode);

// âœ… EXTRA RULE: if No Renaming, we must ensure there is NO borrow AND NO block
const validNoRename = (mode !== "none")
  ? true
  : (!acts.some(x => x.type === "borrow" || x.type === "block"));

if (match && validNoRename){
  a = aa; b = bb;
  ok = true;
  break;
}


      A = savedA; B = savedB;

      if (match){
        a = aa; b = bb;
        ok = true;
        break;
      }
    }

    if (!ok){
      a = randomMoneyUpTo(maxD);
      b = randomMoneyUpTo(maxD);
      if (a < b){ const t=a; a=b; b=t; }
    }

    A = a; B = b;
    enforceSubRule();
    ui.inA.value = formatMoney(A).replace(/^\$/,"");
    ui.inB.value = formatMoney(B).replace(/^\$/,"");
    renderAll();
  });

  ui.btnChildCheck.addEventListener("click", checkChildAnswer);
  ui.childAns.addEventListener("keydown", (e) => {
    if (e.key === "Enter") checkChildAnswer();
  });

  ui.childAns.addEventListener("focus", () => {
    if (!ui.childAns.value) ui.childAns.value = "$";
  });
  ui.childAns.addEventListener("input", () => {
    let v = ui.childAns.value || "";
    if (v && v[0] !== "$") v = "$" + v.replace(/\$/g,"");
    ui.childAns.value = v;
  });

  window.addEventListener("resize", () => {
    requestAnimationFrame(() => {
      fitAllPiles();
      fitAlgo();
    });
  });

  // ======= INIT =======
  A = normalizeMoneyInput("31.60");
  B = normalizeMoneyInput("20.90");
  ui.inA.value = "31.60";
  ui.inB.value = "20.90";

  syncNoRenameUI();
  renderAll();
})();
</script>
</body>
</html>
